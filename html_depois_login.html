<!DOCTYPE html><html lang="pt-BR"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NomaTV - Painel Super Admin v4.4</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="api.js"></script>
    <style>
        /* Reset e Base */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f8fafc; 
            color: #2d3748; 
            overflow-x: hidden; 
        }

        /* Sidebar */
        .sidebar { 
            position: fixed; 
            left: 0; 
            top: 0; 
            width: 280px; 
            height: 100vh; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            z-index: 1000; 
            transition: transform 0.3s ease; 
            overflow-y: auto; 
        }
        .sidebar.collapsed { transform: translateX(-280px); }
        .sidebar-header { 
            padding: 25px 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
        }
        .logo-admin { 
            font-size: 24px; 
            font-weight: bold; 
            margin-bottom: 5px; 
        }
        .user-info { 
            font-size: 14px; 
            opacity: 0.8; 
        }
        .nav-menu { padding: 20px 0; }
        .nav-item { 
            padding: 12px 20px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            border-left: 4px solid transparent; 
            display: flex; 
            align-items: center; 
        }
        .nav-item:hover { 
            background: rgba(255,255,255,0.1); 
            border-left-color: #fff; 
        }
        .nav-item.active { 
            background: rgba(255,255,255,0.2); 
            border-left-color: #fff; 
        }
        .nav-icon { 
            margin-right: 12px; 
            font-size: 18px; 
        }

        /* Main Content */
        .main-content { 
            margin-left: 280px; 
            min-height: 100vh; 
            transition: margin-left 0.3s ease; 
        }
        .main-content.expanded { margin-left: 0; }

        /* Header */
        .header { 
            background: white; 
            padding: 15px 30px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .header-left { display: flex; align-items: center; }
        .menu-toggle { 
            background: none; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            margin-right: 15px; 
            padding: 8px; 
            border-radius: 5px; 
            transition: background 0.3s; 
            color: #2d3748; 
        }
        .menu-toggle:hover { background: #f1f5f9; }
        .page-title { 
            font-size: 24px; 
            font-weight: 600; 
            color: #1a202c; 
        }
        .header-right { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .logout-btn { 
            background: #e53e3e; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: background 0.3s; 
        }
        .logout-btn:hover { background: #c53030; }

        /* Content */
        .content { padding: 30px; }
        .section-content { display: none; }
        .section-content.active { display: block; }

        /* Form & Table Styles */
        .form-section, .table-wrapper { 
            background: #ffffff; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 30px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .form-section-title, .table-title { 
            font-size: 18px; 
            font-weight: 600; 
            margin-bottom: 20px; 
            color: #1a202c; 
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
        }
        .form-group { margin-bottom: 20px; }
        .form-label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500; 
            color: #4a5568; 
        }
        .form-input, .form-select { 
            width: 100%; 
            padding: 12px 14px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 14px; 
            transition: border-color 0.3s; 
        }
        .form-input:focus, .form-select:focus { 
            outline: none; 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
        }
        .form-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        
        /* Buttons */
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: all 0.3s; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            font-weight: 600;
        }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-icon { padding: 6px 8px; font-size: 14px; position: relative; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover:not(:disabled) { background: #5a67d8; }
        .btn-secondary { background: #4a5568; color: white; }
        .btn-secondary:hover:not(:disabled) { background: #2d3748; }
        .btn-danger { background: #e53e3e; color: white; }
        .btn-danger:hover:not(:disabled) { background: #c53030; }
        .btn-success { background: #38a169; color: white; }
        .btn-success:hover:not(:disabled) { background: #2f855a; }
        .btn[title]:disabled:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
        }

        /* Modal */
        .modal { 
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; 
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(4px); 
        }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { 
            background: white; border-radius: 12px; width: 90%; max-width: 600px;
            max-height: 90vh; display: flex; flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
        }
        #revendedorModal .modal-content {
            max-width: 700px;
        }

        .modal-header { 
            padding: 20px 25px; border-bottom: 1px solid #e2e8f0; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .modal-header h3 { margin: 0; color: #1a202c; font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #718096; }
        .modal-body { padding: 25px; overflow-y: auto; }
        .modal-footer { 
            padding: 20px 25px; border-top: 1px solid #e2e8f0; 
            display: flex; gap: 10px; justify-content: flex-end; 
        }

        /* Table */
        .table-container { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        .table th { background: #f7fafc; font-weight: 600; color: #4a5568; font-size: 12px; }
        .table tr:hover { background: #f7fafc; }

        /* Loading & Alert */
        .loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; 
            z-index: 9999; flex-direction: column;
        }
        .loading-overlay.show { display: flex; }
        .loading-spinner { 
            width: 40px; height: 40px; border: 4px solid #e2e8f0; 
            border-top: 4px solid #667eea; border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        .loading-text { margin-top: 15px; font-weight: 500; color: #4a5568; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .alert-container {
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .alert {
            padding: 15px 20px; border-radius: 8px; color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex;
            align-items: center; gap: 10px; min-width: 300px;
        }
        .alert-success { background-color: #38a169; }
        .alert-error { background-color: #e53e3e; }

        /* Filters Bar */
        .filters-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
        }
        .pagination-info { font-size: 14px; color: #718096; }
        .pagination-controls { display: flex; gap: 5px; }

        /* Password Strength Bar */
        .password-strength-bar {
            height: 8px; width: 100%; background: #e2e8f0;
            border-radius: 4px; margin-top: 8px; overflow: hidden;
        }
        .strength-meter {
            height: 100%; width: 0; border-radius: 4px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        .strength-meter.muito-fraca { width: 20%; background-color: #e53e3e; }
        .strength-meter.fraca { width: 40%; background-color: #dd6b20; }
        .strength-meter.media { width: 60%; background-color: #d69e2e; }
        .strength-meter.boa { width: 80%; background-color: #38a169; }
        .strength-meter.forte { width: 100%; background-color: #2f855a; }
        .strength-text { font-size: 12px; font-weight: 500; margin-top: 4px; }
        .info-panel {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .info-item {
            background: #f7fafc; padding: 15px; border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .info-label { font-weight: 600; color: #4a5568; }
        .info-value { color: #2d3748; word-break: break-all; }

        /* Billing Model Selection */
        .billing-model {
            border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px;
            margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .billing-model:hover { border-color: #c7d2fe; }
        .billing-model.selected { border-color: #667eea; background-color: #f0f2ff; }
        .billing-model input[type="radio"] {
            margin-top: 4px;
            flex-shrink: 0;
        }
        .billing-model-title { font-weight: 600; color: #4a5568; margin-bottom: 5px; }
        .billing-model-desc { font-size: 13px; color: #718096; }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 12px; border-radius: 9999px; font-size: 12px;
            font-weight: 600; text-transform: uppercase;
        }
        .status-ativo { background-color: #c6f6d5; color: #22543d; }
        .status-inativo { background-color: #fed7d7; color: #742a2a; }
        .status-bloqueado { background-color: #ffedd5; color: #9c4221; } /* Nova cor para bloqueado */
        .status-suspeito { background-color: #fee2e2; color: #e53e3e; } /* Cor para suspeito */
        .status-monitorado { background-color: #e0f2f7; color: #2c5282; } /* Cor para monitorado */
        .status-permitido { background-color: #d1fae5; color: #065f46; } /* Cor para permitido */
        .status-pendente { background-color: #fff3e0; color: #9c4221; } /* Cor para pendente */
        .status-parcialmente_paga { background-color: #fefcbf; color: #825a2c; } /* Cor para parcialmente paga */
        .status-paga { background-color: #c6f6d5; color: #22543d; } /* Cor para paga */
        .status-cancelada { background-color: #e2e8f0; color: #4a5568; } /* Cor para cancelada */


        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .stat-value { font-size: 32px; font-weight: bold; color: #1a202c; }
        .stat-label { color: #718096; font-size: 14px; margin-top: 5px; }
        .stat-icon {
            width: 50px; height: 50px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white;
        }

        /* Bulk Actions Bar */
        .bulk-actions-bar {
            display: none; /* Escondido por padrão */
            background-color: #e0f2f7; /* Cor de fundo suave */
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .bulk-actions-bar.show {
            display: flex;
        }
        .selected-count {
            font-weight: 600;
            color: #2c5282;
        }

        /* Report Specific Styles */
        .report-section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1a202c;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
            margin-top: 25px;
        }
        .report-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .report-summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        .report-summary-value {
            font-size: 28px;
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 5px;
        }
        .report-summary-label {
            font-size: 14px;
            color: #718096;
        }
        .report-table-container {
            margin-top: 20px;
        }
        .report-empty-state, .finance-empty-state, .permissions-empty-state, .ips-empty-state {
            text-align: center;
            padding: 40px;
            color: #718096;
            font-size: 16px;
            background-color: #f7fafc;
            border-radius: 12px;
            margin-top: 30px;
        }

        /* Permissions Specific Styles */
        .permission-category-header {
            font-size: 16px;
            font-weight: 600;
            color: #4a5568;
            background-color: #edf2f7;
            padding: 10px 15px;
            border-bottom: 1px solid #e2e8f0;
            margin-top: 20px;
        }
        .permission-category-header:first-of-type {
            margin-top: 0;
        }
        .permission-checkbox-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .permission-checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: normal;
            margin-bottom: 0;
            cursor: pointer;
        }
        .permission-checkbox-group input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Container para Alertas -->
    <div id="alertContainer" class="alert-container"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p id="loadingText" class="loading-text">Carregando estatísticas...</p>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-admin">NomaTV Admin v4.4</div>
            <div class="user-info">👑 Super Administrador</div>
        </div>
        <nav class="nav-menu">
            <div class="nav-item active" onclick="showSection('dashboard', this)"><span class="nav-icon">📊</span> Dashboard</div>
            <div class="nav-item" onclick="showSection('revendedores', this)"><span class="nav-icon">🏢</span> Revendedores</div>
            <div class="nav-item" onclick="showSection('provedores', this)"><span class="nav-icon">🔗</span> Provedores</div>
            <div class="nav-item" onclick="showSection('ativos', this)"><span class="nav-icon">📱</span> Gerenciar Ativos</div>
            <div class="nav-item" onclick="showSection('logs', this)"><span class="nav-icon">🔍</span> Logs de Atividade</div>
            <div class="nav-item" onclick="showSection('relatorios', this)"><span class="nav-icon">📈</span> Relatórios</div>
            <div class="nav-item" onclick="showSection('permissoes', this)"><span class="nav-icon">🛡️</span> Controle de Permissões</div>
            <div class="nav-item" onclick="showSection('ips', this)"><span class="nav-icon">🌐</span> Controle de IPs</div>
            <div class="nav-item" onclick="showSection('financeiro', this)"><span class="nav-icon">💰</span> Financeiro</div>
            <div class="nav-item" onclick="showSection('planos', this)"><span class="nav-icon">📦</span> Planos e Pacotes</div>
            <div class="nav-item" onclick="showSection('seguranca', this)"><span class="nav-icon">🔐</span> Segurança &amp; Domínio</div>
            <div class="nav-item" onclick="showSection('configuracoes', this)"><span class="nav-icon">⚙️</span> Configurações</div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle" onclick="toggleMenu()">☰</button>
                <h1 class="page-title" id="pageTitle">📊 Dashboard</h1>
            </div>
            <div class="header-right">
                <span id="currentUser">admin@nomatv.com</span>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>
        </header>

        <!-- Content Area -->
        <main class="content">
            <!-- Dashboard Section -->
            <div id="dashboard-content" class="section-content active">
                <div id="dashboardStats" class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value">0</div><div class="stat-label">Revendedores Ativos</div></div>
                            <div class="stat-icon" style="background: #667eea;">🏢</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value">0</div><div class="stat-label">Clientes Ativos</div></div>
                            <div class="stat-icon" style="background: #38a169;">📱</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value">0</div><div class="stat-label">Provedores Ativos</div></div>
                            <div class="stat-icon" style="background: #4299e1;">🔗</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value">0</div><div class="stat-label">Painéis Vencidos</div></div>
                            <div class="stat-icon" style="background: #d69e2e;">⚠️</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Seção de Revendedores -->
            <div id="revendedores-content" class="section-content">
                <div class="table-wrapper">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="table-title" style="margin-bottom: 0;">🏢 Revendedores</h2>
                        <button class="btn btn-primary" onclick="openRevendedorModal()">➕ Novo Revendedor</button>
                    </div>
                    <div class="filters-bar">
                        <input type="text" id="revendedoresSearch" class="form-input" style="flex: 2;" placeholder="Buscar por nome, usuário ou ID...">
                        <select id="revendedoresStatusFilter" class="form-select" style="flex: 1;">
                            <option value="">Todos os Status</option>
                            <option value="ativo">Ativos</option>
                            <option value="inativo">Bloqueados</option>
                        </select>
                        <button class="btn btn-primary" onclick="filterRevendedores()">Filtrar</button>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Revendedor</th>
                                    <th>Status</th>
                                    <th>Ativos / Limite</th>
                                    <th>Provedores</th>
                                    <th>Vencimento</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="revendedoresTableBody"></tbody>
                        </table>
                    </div>
                    <div id="revendedoresPagination" class="pagination-container">
                        <div id="revendedoresPaginationInfo" class="pagination-info"></div>
                        <div class="pagination-controls">
                            <button id="revendedoresPrevPage" class="btn btn-secondary btn-sm">Anterior</button>
                            <span id="revendedoresPageIndicator" style="padding: 0 10px; font-weight: 500;"></span>
                            <button id="revendedoresNextPage" class="btn btn-secondary btn-sm">Próxima</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Provedores -->
            <div id="provedores-content" class="section-content">
                <div class="table-wrapper">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="table-title" style="margin-bottom: 0;">🔗 Provedores</h2>
                        <button class="btn btn-primary" onclick="openProvedorModal()">➕ Novo Provedor</button>
                    </div>
                    <div class="filters-bar">
                        <input type="text" id="provedoresSearch" class="form-input" style="flex: 2;" placeholder="Buscar por nome ou DNS...">
                        <select id="provedoresStatusFilter" class="form-select" style="flex: 1;">
                            <option value="">Todos os Status</option>
                            <option value="1">Ativos</option>
                            <option value="0">Inativos</option>
                        </select>
                        <select id="provedoresTipoFilter" class="form-select" style="flex: 1;">
                            <option value="">Todos os Tipos</option>
                            <option value="xtream">Xtream</option>
                            <option value="m3u">M3U</option>
                            <option value="outro">Outro</option>
                        </select>
                        <select id="provedoresOwnerFilter" class="form-select" style="flex: 1;">
                            <option value="">Todos os Proprietários</option>
                            <!-- Opções carregadas dinamicamente -->
                        </select>
                        <button class="btn btn-primary" onclick="filterProvedores()">Filtrar</button>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>DNS</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th>Ativos</th>
                                    <th>Proprietário</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="provedoresTableBody"></tbody>
                        </table>
                    </div>
                    <div id="provedoresPagination" class="pagination-container">
                        <div id="provedoresPaginationInfo" class="pagination-info"></div>
                        <div class="pagination-controls">
                            <button id="provedoresPrevPage" class="btn btn-secondary btn-sm">Anterior</button>
                            <span id="provedoresPageIndicator" style="padding: 0 10px; font-weight: 500;"></span>
                            <button id="provedoresNextPage" class="btn btn-secondary btn-sm">Próxima</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Gerenciar Ativos -->
            <div id="ativos-content" class="section-content">
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value" id="totalAtivosStat">0</div><div class="stat-label">Total de Ativos</div></div>
                            <div class="stat-icon" style="background: #667eea;">📱</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value" id="ativosOnlineStat">0</div><div class="stat-label">Ativos Online</div></div>
                            <div class="stat-icon" style="background: #38a169;">🟢</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value" id="ativosInativosStat">0</div><div class="stat-label">Ativos Inativos</div></div>
                            <div class="stat-icon" style="background: #d69e2e;">🟡</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value" id="ativosBloqueadosStat">0</div><div class="stat-label">Ativos Bloqueados</div></div>
                            <div class="stat-icon" style="background: #e53e3e;">🔴</div>
                        </div>
                    </div>
                </div>

                <div class="table-wrapper">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="table-title" style="margin-bottom: 0;">📱 Gerenciar Ativos (Client IDs)</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="openAtivoModal()">➕ Novo Ativo</button>
                            <button class="btn btn-secondary" onclick="handleExportClientIds()">⬇️ Exportar CSV</button>
                        </div>
                    </div>
                    <div class="filters-bar">
                        <input type="text" id="ativosSearch" class="form-input" style="flex: 2;" placeholder="Buscar por Client ID, Usuário ou IP...">
                        <select id="ativosStatusFilter" class="form-select" style="flex: 1;">
                            <option value="">Todos os Status</option>
                            <option value="ativo">Ativos</option>
                            <option value="inativo">Inativos</option>
                            <option value="bloqueado">Bloqueados</option>
                        </select>
                        <select id="ativosRevendedorFilter" class="form-select" style="flex: 1;">
                            <option value="">Todos os Revendedores</option>
                            <!-- Opções carregadas dinamicamente -->
                        </select>
                        <select id="ativosProvedorFilter" class="form-select" style="flex: 1;">
                            <option value="">Todos os Provedores</option>
                            <!-- Opções carregadas dinamicamente -->
                        </select>
                        <button class="btn btn-primary" onclick="filterAtivos()">Filtrar</button>
                    </div>

                    <!-- Barra de Ações em Lote -->
                    <div id="bulkActionsBar" class="bulk-actions-bar">
                        <span id="selectedCount" class="selected-count">0 ativos selecionados</span>
                        <div>
                            <button class="btn btn-danger btn-sm" onclick="performBulkAction('bloquear')">🔒 Bloquear Selecionados</button>
                            <button class="btn btn-success btn-sm" onclick="performBulkAction('ativar')">🔓 Ativar Selecionados</button>
                            <button class="btn btn-secondary btn-sm" onclick="performBulkAction('desativar')">🚫 Desativar Selecionados</button>
                            <button class="btn btn-danger btn-sm" onclick="performBulkAction('excluir')">🗑️ Excluir Selecionados</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllAtivos" onchange="toggleSelectAllAtivos()"></th>
                                    <th>Client ID</th>
                                    <th>Usuário</th>
                                    <th>Revendedor</th>
                                    <th>Provedor</th>
                                    <th>Status</th>
                                    <th>Última Atividade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="ativosTableBody"></tbody>
                        </table>
                    </div>
                    <div id="ativosPagination" class="pagination-container">
                        <div id="ativosPaginationInfo" class="pagination-info"></div>
                        <div class="pagination-controls">
                            <button id="ativosPrevPage" class="btn btn-secondary btn-sm">Anterior</button>
                            <span id="ativosPageIndicator" style="padding: 0 10px; font-weight: 500;"></span>
                            <button id="ativosNextPage" class="btn btn-secondary btn-sm">Próxima</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Seção de Relatórios -->
            <div id="relatorios-content" class="section-content">
                <div class="table-wrapper">
                    <h2 class="table-title">📈 Relatórios do Sistema</h2>
                    <div class="filters-bar">
                        <div class="form-group" style="flex: 2;">
                            <label for="reportTypeSelect" class="form-label">Tipo de Relatório</label>
                            <select id="reportTypeSelect" class="form-select">
                                <option value="dashboard">Dashboard (Visão Geral)</option>
                                <option value="financeiro">Financeiro</option>
                                <option value="revendedores">Revendedores</option>
                                <option value="provedores">Provedores</option>
                                <option value="atividade">Atividade</option>
                                <option value="crescimento">Crescimento</option>
                                <option value="completo">Relatório Completo</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label" for="reportPeriodSelect">Período</label>
                            <select id="reportPeriodSelect" class="form-select">
                                <option value="7">Últimos 7 dias</option>
                                <option value="30" selected="">Últimos 30 dias</option>
                                <option value="90">Últimos 90 dias</option>
                                <option value="ano_atual">Ano Atual</option>
                                <option value="total">Total (Desde o Início)</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end; gap: 10px;">
                            <button class="btn btn-primary" onclick="filterRelatorios()">📊 Gerar Relatório</button>
                            <button class="btn btn-secondary" onclick="handleExportRelatorio()">⬇️ Exportar</button>
                        </div>
                    </div>
                    <div id="reportDisplayArea">
                        <!-- Conteúdo do relatório será carregado aqui -->
                        <div class="report-empty-state">
                            Selecione um tipo de relatório e um período para gerar.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Permissões -->
            <div id="permissoes-content" class="section-content">
                <div class="table-wrapper">
                    <h2 class="table-title">🛡️ Controle de Permissões</h2>
                    <p style="margin-bottom: 20px; color: #4a5568;">Defina quais funcionalidades cada tipo de usuário pode acessar no sistema.</p>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Funcionalidade</th>
                                    <th>Descrição</th>
                                    <th>Categoria</th>
                                    <th>Admin</th>
                                    <th>Master</th>
                                    <th>Sub</th>
                                    <th>Ativo</th>
                                </tr>
                            </thead>
                            <tbody id="permissoesTableBody">
                                <!-- Permissões carregadas via JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="permissions-empty-state" style="display:none;">
                        Nenhuma permissão encontrada.
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="handleSavePermissoes()">💾 Salvar Permissões</button>
                    </div>
                </div>
            </div>
            
            <!-- Seção de Controle de IPs -->
            <div id="ips-content" class="section-content">
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value" id="ipsTotalStat">0</div><div class="stat-label">Total de IPs</div></div>
                            <div class="stat-icon" style="background: #667eea;">🌐</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value" id="ipsBloqueadosStat">0</div><div class="stat-label">IPs Bloqueados</div></div>
                            <div class="stat-icon" style="background: #e53e3e;">🚫</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value" id="ipsSuspeitosStat">0</div><div class="stat-label">IPs Suspeitos</div></div>
                            <div class="stat-icon" style="background: #d69e2e;">❓</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value" id="ipsMonitoradosStat">0</div><div class="stat-label">IPs Monitorados</div></div>
                            <div class="stat-icon" style="background: #4299e1;">👀</div>
                        </div>
                    </div>
                </div>

                <div class="table-wrapper">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="table-title" style="margin-bottom: 0;">🌐 Controle de IPs</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="openIpModal()">➕ Novo IP</button>
                            <button class="btn btn-secondary" onclick="handleExportIps()">⬇️ Exportar CSV</button>
                        </div>
                    </div>
                    <div class="filters-bar">
                        <input type="text" id="ipsSearch" class="form-input" style="flex: 2;" placeholder="Buscar por IP, Observações, País ou Provedor...">
                        <select id="ipsStatusFilter" class="form-select" style="flex: 1;">
                            <option value="">Todos os Status</option>
                            <option value="permitido">Permitido</option>
                            <option value="bloqueado">Bloqueado</option>
                            <option value="suspeito">Suspeito</option>
                            <option value="monitorado">Monitorado</option>
                        </select>
                        <select id="ipsPaisFilter" class="form-select" style="flex: 1;">
                            <option value="">Todos os Países</option>
                            <!-- Opções carregadas dinamicamente -->
                        </select>
                        <select id="ipsProvedorFilter" class="form-select" style="flex: 1;">
                            <option value="">Todos os Provedores</option>
                            <!-- Opções carregadas dinamicamente -->
                        </select>
                        <button class="btn btn-primary" onclick="filterIps()">Filtrar</button>
                    </div>

                    <!-- Barra de Ações em Lote para IPs -->
                    <div id="bulkActionsBarIps" class="bulk-actions-bar">
                        <span id="selectedCountIps" class="selected-count">0 IPs selecionados</span>
                        <div>
                            <button class="btn btn-danger btn-sm" onclick="performBulkActionIps('bloquear')">🚫 Bloquear Selecionados</button>
                            <button class="btn btn-success btn-sm" onclick="performBulkActionIps('permitir')">✅ Permitir Selecionados</button>
                            <button class="btn btn-warning btn-sm" onclick="performBulkActionIps('marcar_suspeito')">❓ Marcar Suspeito</button>
                            <button class="btn btn-info btn-sm" onclick="performBulkActionIps('marcar_monitorado')">👀 Marcar Monitorado</button>
                            <button class="btn btn-danger btn-sm" onclick="performBulkActionIps('excluir')">🗑️ Excluir Selecionados</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllIps" onchange="toggleSelectAllIps()"></th>
                                    <th>IP</th>
                                    <th>Status</th>
                                    <th>País</th>
                                    <th>Cidade</th>
                                    <th>Provedor</th>
                                    <th>Tentativas Falhas</th>
                                    <th>Score Risco</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="ipsTableBody"></tbody>
                        </table>
                    </div>
                    <div id="ipsPagination" class="pagination-container">
                        <div id="ipsPaginationInfo" class="pagination-info"></div>
                        <div class="pagination-controls">
                            <button id="ipsPrevPage" class="btn btn-secondary btn-sm">Anterior</button>
                            <span id="ipsPageIndicator" style="padding: 0 10px; font-weight: 500;"></span>
                            <button id="ipsNextPage" class="btn btn-secondary btn-sm">Próxima</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Seção de Financeiro -->
            <div id="financeiro-content" class="section-content">
                <div class="table-wrapper">
                    <h2 class="table-title">💰 Dashboard Financeiro</h2>
                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div><div class="stat-value" id="financeiroReceitaMensalPrevista">R$ 0,00</div><div class="stat-label">Receita Mensal Prevista</div></div>
                                <div class="stat-icon" style="background: #38a169;">💲</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div><div class="stat-value" id="financeiroTotalRevendedoresAtivos">0</div><div class="stat-label">Revendedores Ativos</div></div>
                                <div class="stat-icon" style="background: #667eea;">🏢</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div><div class="stat-value" id="financeiroRevendedoresVencidos">0</div><div class="stat-label">Revendedores Vencidos</div></div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div><div class="stat-value" id="financeiroRevendedoresProximoVencimento">0</div><div class="stat-label">Próximos a Vencer</div></div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="processarCobranca()">🔄 Processar Cobranças</button>
                        <button class="btn btn-danger" onclick="bloquearRevendedoresVencidos()">🔒 Bloquear Vencidos</button>
                        <button class="btn btn-secondary" onclick="openGerarFaturaManualModal()">➕ Fatura Manual</button>
                    </div>

                    <h3 class="report-section-title">Histórico de Cobranças e Status</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Revendedor</th>
                                    <th>Tipo Cobrança</th>
                                    <th>Ativos Online</th>
                                    <th>Valor Previsto</th>
                                    <th>Vencimento</th>
                                    <th>Status Pagamento</th>
                                    <th>Última Atividade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="financeiroTableBody">
                                <!-- Dados carregados via JS -->
                            </tbody>
                        </table>
                    </div>
                    <div id="financeiroEmptyState" class="finance-empty-state" style="display:none;">
                        Nenhum dado financeiro encontrado.
                    </div>

                    <h3 class="report-section-title">Projeções e Análises</h3>
                    <div class="info-panel" id="financeiroAnalisesProjecoes">
                        <!-- Dados carregados via JS -->
                    </div>
                </div>
            </div>
            
            <!-- Seção de Planos e Pacotes -->
            <div id="planos-content" class="section-content">
                <div class="table-wrapper">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="table-title" style="margin-bottom: 0;">📦 Planos e Pacotes</h2>
                        <button class="btn btn-primary" onclick="openPlanoModal()">➕ Novo Plano</button>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome do Plano</th><th>Valor (R$)</th><th>Limite de Ativos</th><th>Validade (dias)</th><th>Revendedores Usando</th><th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="planosTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Seção de Segurança & Domínio -->
            <div id="seguranca-content" class="section-content">
                <div class="form-section">
                    <h2 class="form-section-title">🔐 Alteração de Senha de Administrador</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="senhaAtual">Senha Atual</label>
                            <input type="password" id="senhaAtual" class="form-input" placeholder="Digite sua senha atual" required="">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="novaSenha">Nova Senha</label>
                            <input type="password" id="novaSenha" class="form-input" placeholder="Nova senha forte" required="">
                            <div class="password-strength-bar"><div id="strengthMeter" class="strength-meter"></div></div>
                            <div id="strengthText" class="strength-text"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="confirmarSenha">Confirmar Nova Senha</label>
                            <input type="password" id="confirmarSenha" class="form-input" placeholder="Confirme a nova senha" required="">
                        </div>
                    </div>
                    <button id="btnAlterarSenha" class="btn btn-primary" onclick="handleAlterarSenha()" disabled="">🔑 Alterar Senha</button>
                </div>
                <div class="form-section">
                    <h2 class="form-section-title">🌐 Informações do Domínio/Servidor</h2>
                    <div id="serverInfoPanel" class="info-panel"></div>
                </div>
            </div>

            <!-- Seção de Logs de Atividade -->
            <div id="logs-content" class="section-content">
                <div class="table-wrapper">
                    <h2 class="table-title">🔍 Logs de Atividade do Sistema</h2>
                    <div class="filters-bar">
                        <input type="text" id="logsSearch" class="form-input" style="flex: 2;" placeholder="Buscar...">
                        <input type="date" id="logsDateFilter" class="form-select" style="flex: 1;">
                        <select id="logsActionFilter" class="form-select" style="flex: 1;"><option value="">Todas as Ações</option><option value="login">Login</option></select>
                        <button class="btn btn-primary" onclick="filterLogs()">Filcar</button>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead><tr><th>Usuário</th><th>Ação</th><th>Detalhes</th><th>IP</th><th>Data/Hora</th></tr></thead>
                            <tbody id="logsTableBody"></tbody>
                        </table>
                    </div>
                    <div id="logsPagination" class="pagination-container">
                        <div id="logsPaginationInfo" class="pagination-info"></div>
                        <div class="pagination-controls">
                            <button id="logsPrevPage" class="btn btn-secondary btn-sm">Anterior</button>
                            <span id="logsPageIndicator" style="padding: 0 10px; font-weight: 500;"></span>
                            <button id="logsNextPage" class="btn btn-secondary btn-sm">Próxima</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Configurações -->
            <div id="configuracoes-content" class="section-content">
                <div class="form-section">
                    <div class="form-section-title">⚙️ Configurações Gerais</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="nomeSistema">Nome do Sistema</label>
                            <input type="text" id="nomeSistema" class="form-input" value="NomaTV Painel">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="idiomaPadrao">Idioma Padrão</label>
                            <select id="idiomaPadrao" class="form-select"><option value="pt-BR">Português (Brasil)</option><option value="en-US">English (US)</option></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="fusoHorario">Fuso Horário</label>
                        <select id="fusoHorario" class="form-select"><option value="America/Sao_Paulo">América/São Paulo (UTC-3)</option><option value="America/New_York">América/Nova York (UTC-5)</option></select>
                    </div>
                    <button class="btn btn-primary" onclick="saveConfigGerais()">💾 Salvar Configurações</button>
                </div>
                <div class="form-section">
                    <div class="form-section-title">🛡️ Backup &amp; Restauração</div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-success" id="btnCriarBackup" onclick="handleCreateBackup()">💾 Criar e Baixar Backup</button>
                        <button class="btn btn-secondary" onclick="openBackupModal()">📂 Gerenciar Backups</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Revendedor -->
    <div id="revendedorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="revendedorModalTitle">➕ Criar Novo Revendedor</h3>
                <button class="modal-close" onclick="closeModal('revendedorModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="revendedorForm">
                    <input type="hidden" id="revendedorId">
                    
                    <h4 style="margin-bottom: 15px; color: #4f46e5;">Dados de Acesso</h4>
                    <div class="form-row"> <!-- Usando form-row para 2 colunas -->
                        <div class="form-group">
                            <label class="form-label" for="revendedorNome">Nome Completo</label>
                            <input type="text" id="revendedorNome" class="form-input" required="">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="revendedorUsuario">Nome de Usuário</label>
                            <input type="text" id="revendedorUsuario" class="form-input" required="">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="revendedorSenha">Senha</label>
                        <input type="password" id="revendedorSenha" class="form-input" required="">
                        <small style="color: #6b7280;">Deixe em branco para manter a senha atual ao editar.</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="revendedorEmail">Email (Opcional)</label>
                        <input type="email" id="revendedorEmail" class="form-input">
                    </div>

                    <h4 style="margin: 25px 0 15px; color: #4f46e5;">Configurações e Faturamento</h4>
                    
                    <div class="form-row"> <!-- Usando form-row para 2 colunas -->
                        <div class="form-group">
                            <label class="form-label" for="revendedorMaster">Tipo de Painel</label>
                            <select id="revendedorMaster" class="form-select">
                                <option value="nao">Sub-Revendedor</option>
                                <option value="sim">Revendedor Master</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="revendedorPlano">Plano</label>
                            <select id="revendedorPlano" class="form-select">
                                <option value="Básico">📦 Básico (Padrão)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="revendedorLimiteAtivos">Limite de Ativos</label>
                        <input type="number" id="revendedorLimiteAtivos" class="form-input" value="100" placeholder="0 = Ilimitado">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Modelo de Cobrança</label>
                        <div class="billing-models">
                            <div class="billing-model" onclick="updateBillingSelection(this.querySelector('input'))">
                                <input type="radio" name="tipo_cobranca" value="por_ativo">
                                <h4>Cobrança por Ativo</h4>
                                <p>Paga com base no número de clientes ativos.</p>
                            </div>
                            <div class="billing-model selected" onclick="updateBillingSelection(this.querySelector('input'))">
                                <input type="radio" name="tipo_cobranca" value="mensal" checked="">
                                <h4>Mensalista Fixo</h4>
                                <p>Paga um valor fixo mensal (PADRÃO).</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-row"> <!-- Usando form-row para 2 colunas -->
                        <div class="form-group">
                            <label class="form-label" for="revendedorValorCobranca">Valor da Cobrança (R$)</label>
                            <input type="text" id="revendedorValorCobranca" class="form-input" value="50,00" placeholder="50,00">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="revendedorVencimento">Data de Vencimento</label>
                            <input type="date" id="revendedorVencimento" class="form-input">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('revendedorModal')">Cancelar</button>
                <button class="btn btn-primary" id="btnSalvarRevendedor" onclick="salvarRevendedor()">Salvar</button>
            </div>
        </div>
    </div>
    <div id="provedorModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="provedorModalTitle">Criar Novo Provedor</h3>
                <button class="modal-close" onclick="closeModal('provedorModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="provedorForm" oninput="validateProvedorForm()">
                    <input type="hidden" id="provedorId">
                    <div class="form-group">
                        <label for="provedorNome" class="form-label">Nome do Provedor</label>
                        <input type="text" id="provedorNome" class="form-input" required="">
                    </div>
                    <div class="form-group">
                        <label for="provedorDns" class="form-label">DNS / URL</label>
                        <input type="url" id="provedorDns" class="form-input" placeholder="http://exemplo.com:8080" required="">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="provedorTipo" class="form-label">Tipo</label>
                            <select id="provedorTipo" class="form-select">
                                <option value="xtream">Xtream</option>
                                <option value="m3u">M3U</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="provedorStatus" class="form-label">Status</label>
                            <select id="provedorStatus" class="form-select">
                                <option value="1">Ativo</option>
                                <option value="0">Inativo</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="provedorOwnerGroup">
                        <label for="provedorOwner" class="form-label">Revendedor Proprietário</label>
                        <select id="provedorOwner" class="form-select"></select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="btnSalvarProvedor" onclick="salvarProvedor()">Salvar</button>
                <button class="btn btn-secondary" onclick="closeModal('provedorModal')">Cancelar</button>
            </div>
        </div>
    </div>
    <div id="planoModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="planoModalTitle">Criar Novo Plano</h3>
                <button class="modal-close" onclick="closeModal('planoModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="planoForm">
                    <input type="hidden" id="planoId">
                    <div class="form-group"><label for="planoNome" class="form-label">Nome do Plano</label><input type="text" id="planoNome" class="form-input" required=""></div>
                    <div class="form-row">
                        <div class="form-group"><label for="planoValor" class="form-label">Valor (R$)</label><input type="number" id="planoValor" class="form-input" step="0.01" required=""></div>
                        <div class="form-group"><label for="planoLimiteAtivos" class="form-label">Limite de Ativos</label><input type="number" id="planoLimiteAtivos" class="form-input" placeholder="0 = Ilimitado" required=""></div>
                    </div>
                    <div class="form-group"><label for="planoValidade" class="form-label">Validade (dias)</label><input type="number" id="planoValidade" class="form-input" value="30" required=""></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="salvarPlano()">Salvar Plano</button>
                <button class="btn btn-secondary" onclick="closeModal('planoModal')">Cancelar</button>
            </div>
        </div>
    </div>
    <div id="backupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📂 Gerenciador de Backups</h3>
                <button class="modal-close" onclick="closeModal('backupModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table class="table">
                        <thead><tr><th>Arquivo</th><th>Data</th><th>Tamanho</th><th>Ações</th></tr></thead>
                        <tbody id="backupTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('backupModal')">Fechar</button></div>
        </div>
    </div>
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirmar Ação</h3>
                <button class="modal-close" onclick="closeModal('confirmModal')">×</button>
            </div>
            <div class="modal-body"><p id="confirmMessage">Tem certeza?</p></div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="confirmButton" onclick="confirmarAcao()">Confirmar</button>
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Ativo -->
    <div id="ativoModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="ativoModalTitle">Adicionar Novo Ativo</h3>
                <button class="modal-close" onclick="closeModal('ativoModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="ativoForm" oninput="validateAtivoForm()">
                    <input type="hidden" id="ativoId"> <!-- Usado para edição, mas o client_id é a chave -->
                    <div class="form-group">
                        <label for="ativoClientId" class="form-label">Client ID (UUID)</label>
                        <input type="text" id="ativoClientId" class="form-input" placeholder="Ex: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx" required="">
                        <small class="form-help">Identificador único do dispositivo. Gerado automaticamente se vazio.</small>
                    </div>
                    <div class="form-group">
                        <label for="ativoUsuario" class="form-label">Usuário (Opcional)</label>
                        <input type="text" id="ativoUsuario" class="form-input" placeholder="Nome do usuário associado">
                    </div>
                    <div class="form-group">
                        <label for="ativoRevendedor" class="form-label">Revendedor Proprietário</label>
                        <select id="ativoRevendedor" class="form-select" required="">
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ativoProvedor" class="form-label">Provedor Conectado</label>
                        <select id="ativoProvedor" class="form-select" required="">
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ativoIp" class="form-label">Endereço IP (Opcional)</label>
                        <input type="text" id="ativoIp" class="form-input" placeholder="Ex: 192.168.1.1">
                    </div>
                    <div class="form-group">
                        <label for="ativoUserAgent" class="form-label">User Agent (Opcional)</label>
                        <input type="text" id="ativoUserAgent" class="form-input" placeholder="Ex: Mozilla/5.0 (SmartTV; Linux)">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="salvarAtivo()">Salvar Ativo</button>
                <button class="btn btn-secondary" onclick="closeModal('ativoModal')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Detalhes do Ativo -->
    <div id="ativoDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="ativoDetailsModalTitle">Detalhes do Ativo</h3>
                <button class="modal-close" onclick="closeModal('ativoDetailsModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="info-panel">
                    <div class="info-item"><div class="info-label">Client ID</div><div class="info-value" id="detailClientId"></div></div>
                    <div class="info-item"><div class="info-label">Usuário</div><div class="info-value" id="detailUsuario"></div></div>
                    <div class="info-item"><div class="info-label">Revendedor</div><div class="info-value" id="detailRevendedor"></div></div>
                    <div class="info-item"><div class="info-label">Provedor</div><div class="info-value" id="detailProvedor"></div></div>
                    <div class="info-item"><div class="info-label">Status</div><div class="info-value" id="detailStatus"></div></div>
                    <div class="info-item"><div class="info-label">IP</div><div class="info-value" id="detailIp"></div></div>
                    <div class="info-item"><div class="info-label">User Agent</div><div class="info-value" id="detailUserAgent"></div></div>
                    <div class="info-item"><div class="info-label">Primeira Conexão</div><div class="info-value" id="detailPrimeiraConexao"></div></div>
                    <div class="info-item"><div class="info-label">Última Atividade</div><div class="info-value" id="detailUltimaAtividade"></div></div>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn btn-secondary" id="btnViewLogs" onclick="">🔍 Ver Logs deste Revendedor</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('ativoDetailsModal')">Fechar</button>
            </div>
        </div>
    </div>


    <script>
        // ==========================================
        // 🚀 NOMATV ADMIN PANEL v4.4 - FULL SCRIPT
        // ==========================================
        
        // ✅ Verificar autenticação ANTES de qualquer coisa
        checkAuthentication();
        
        const appState = {
            logs: { currentPage: 1, totalPages: 1, limit: 25, filters: { search: '', action: '', date: '' } },
            revendedores: { currentPage: 1, totalPages: 1, limit: 25, filters: { search: '', status: '' } },
            provedores: { currentPage: 1, totalPages: 1, limit: 25, filters: { search: '', status: '', tipo: '', id_revendedor: '' } },
            ativos: { currentPage: 1, totalPages: 1, limit: 25, filters: { search: '', status: '', revendedor_id: '', provedor_id: '' }, selectedClientIds: new Set() },
            relatorios: { currentType: 'dashboard', currentPeriod: '30', reportData: null },
            ips: { currentPage: 1, totalPages: 1, limit: 25, filters: { search: '', status: '', pais: '', provedor: '' }, selectedIpIds: new Set() }
        };

        // ==========================================
        // UTILITÁRIOS E NAVEGAÇÃO
        // ==========================================
        function showLoading(text = 'Carregando...') { document.getElementById('loadingText').textContent = text; document.getElementById('loadingOverlay').classList.add('show'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('show'); }
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => { alert.style.transition = 'opacity 0.5s'; alert.style.opacity = '0'; setTimeout(() => alert.remove(), 500); }, 5000);
        }
        let confirmCallback = null;
        function showConfirm(title, message, callback, btnClass = 'btn-primary') {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            const btn = document.getElementById('confirmButton');
            btn.className = `btn ${btnClass}`;
            document.getElementById('confirmModal').classList.add('show');
        }
        function confirmarAcao() { if (confirmCallback) confirmCallback(); closeModal('confirmModal'); }
        function closeModal(modalId) { const modal = document.getElementById(modalId); if(modal) modal.classList.remove('show'); }
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('collapsed'); document.getElementById('mainContent').classList.toggle('expanded'); }
        function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
        function showSection(sectionId, element) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            const content = document.getElementById(`${sectionId}-content`);
            if (content) {
                content.classList.add('active');
                const functionName = `load${capitalize(sectionId.replace(/-/g, ''))}`;
                if (typeof window[functionName] === 'function') window[functionName]();
            }
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('pageTitle').textContent = element.textContent.trim();
        }
        function logout() { showConfirm('Sair do Sistema', 'Tem certeza?', () => { 
            // ✅ LIMPAR TANTO LOCALSTORAGE QUANTO SESSIONSTORAGE
            localStorage.clear();
            sessionStorage.clear();
            showAlert('Logout realizado!', 'success'); 
            setTimeout(() => { window.location.href = '/'; }, 1500); 
        }); }

        // Função para formatar números como moeda
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        // Função para formatar porcentagem
        function formatPercentage(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value / 100);
        }

        // Função para formatar data
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Função para formatar data e hora
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR');
        }

        // Função para gerar UUID (Client ID)
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // ==========================================
        // DASHBOARD
        // ==========================================
        async function loadDashboard() {
            showLoading('Carregando estatísticas...');
            try {
                const response = await getDashboardStats();
                const stats = response.data;
                const statsGrid = document.getElementById('dashboardStats');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value">${stats.totalRevendedores || 0}</div><div class="stat-label">Revendedores Ativos</div></div>
                            <div class="stat-icon" style="background: #667eea;">🏢</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value">${stats.totalAtivos || 0}</div><div class="stat-label">Clientes Ativos</div></div>
                            <div class="stat-icon" style="background: #38a169;">📱</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value">${stats.totalProvedores || 0}</div><div class="stat-label">Provedores Ativos</div></div>
                            <div class="stat-icon" style="background: #4299e1;">🔗</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div><div class="stat-value">${stats.revendedoresVencidos || 0}</div><div class="stat-label">Painéis Vencidos</div></div>
                            <div class="stat-icon" style="background: #d69e2e;">⚠️</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                showAlert('Erro ao carregar o dashboard.', 'error');
                document.getElementById('dashboardStats').innerHTML = '<p>Não foi possível carregar as estatísticas.</p>';
            } finally {
                hideLoading();
            }
        }

        // ==========================================
        // REVENDEDORES
        // ==========================================
        let currentRevendedorId = null;
        async function loadRevendedores(page = 1) { // Adicionado page como parâmetro
            showLoading('Carregando revendedores...');
            try {
                const search = document.getElementById('revendedoresSearch')?.value || '';
                const status = document.getElementById('revendedoresStatusFilter')?.value || '';
                
                const params = {
                    page: page, // Usar o parâmetro page
                    limit: 25,
                    search: search,
                    status: status
                };

                const response = await listarRevendedores(params);
                
                if (response.success) {
                    // appState.revendedores = response; // Não sobrescrever o objeto inteiro
                    appState.revendedores.data = response.data; // Armazenar apenas os dados
                    appState.revendedores.pagination = response.extraData.pagination;
                    appState.revendedores.stats = response.extraData.stats;

                    renderRevendedoresTable(response.data);
                    renderRevendedoresPagination(response.extraData.pagination);
                } else {
                    showAlert('Erro ao carregar revendedores: ' + response.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar revendedores:', error);
                showAlert('Erro ao carregar revendedores: ' + (error.error || 'Tente novamente.'), 'error');
            } finally {
                hideLoading();
            }
        }

        function renderRevendedoresTable(revendedores) {
            const tbody = document.getElementById('revendedoresTableBody');
            
            if (!revendedores || revendedores.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                            Nenhum revendedor encontrado.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = revendedores.map(revendedor => {
                const statusClass = revendedor.ativo ? 'status-ativo' : 'status-inativo';
                const statusText = revendedor.ativo ? 'Ativo' : 'Bloqueado';
                const toggleIcon = revendedor.ativo ? '🔒' : '🔓';
                const toggleClass = revendedor.ativo ? 'btn-danger' : 'btn-success';
                const toggleTitle = revendedor.ativo ? 'Bloquear' : 'Desbloquear';
                
                // Assumindo que 'master' é o tipo (admin, sim, nao)
                const tipoText = revendedor.master === 'sim' ? 'MASTER' : (revendedor.master === 'nao' ? 'SUB' : 'ADMIN');
                const tipoClass = revendedor.master === 'sim' ? 'status-ativo' : (revendedor.master === 'nao' ? 'status-inativo' : 'status-bloqueado'); // Cores diferentes para tipos
                
                const ativosCount = revendedor.ativos_count || 0;
                const limiteAtivos = revendedor.limite_ativos || 0;
                const dataVencimento = revendedor.data_vencimento ? 
                    new Date(revendedor.data_vencimento + 'T00:00:00').toLocaleDateString('pt-BR') : '-'; // Adicionado 'T00:00:00' para evitar problemas de fuso horário

                // Lógica de exclusão: bloqueado E sem sub-revendedores E bloqueado há mais de 3 dias
                const isBlocked = !revendedor.ativo;
                const subResellersCount = revendedor.sub_revendedores_count || 0; // Backend precisa retornar isso
                let daysBlocked = 0;
                if (isBlocked && revendedor.data_bloqueio) { // Backend precisa retornar data_bloqueio
                    const blockDate = new Date(revendedor.data_bloqueio);
                    const today = new Date();
                    daysBlocked = Math.floor((today - blockDate) / (1000 * 60 * 60 * 24));
                }
                const canDelete = isBlocked && subResellersCount === 0 && daysBlocked >= 3;
                let deleteTooltip = canDelete ? 'Excluir permanentemente' : '';
                if (!canDelete) {
                    if (subResellersCount > 0) deleteTooltip = 'Exclua a rede de sub-revendedores primeiro.';
                    else if (!isBlocked) deleteTooltip = 'Bloqueie o revendedor primeiro.';
                    else if (daysBlocked < 3) deleteTooltip = `Aguarde mais ${3 - daysBlocked} dia(s) para excluir.`;
                }

                return `
                    <tr id="revendedor-row-${revendedor.id_revendedor}">
                        <td><code>${revendedor.id_revendedor}</code></td>
                        <td>
                            <div style="font-weight: 600;">${revendedor.nome}</div>
                            <div style="font-size: 12px; color: #6b7280;">${revendedor.usuario}</div>
                        </td>
                        <td><span class="status-badge ${tipoClass}">${tipoText}</span></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${ativosCount} / ${limiteAtivos === 0 ? '∞' : limiteAtivos}</td>
                        <td>${revendedor.provedores_count || 0}</td>
                        <td>${dataVencimento}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm btn-icon" onclick='editRevendedor(${JSON.stringify(revendedor)})' title="Editar">
                                    ✏️
                                </button>
                                <button class="btn ${toggleClass} btn-sm btn-icon" onclick="handleToggleStatus('${revendedor.id_revendedor}')" title="${toggleTitle}">
                                    ${toggleIcon}
                                </button>
                                <button class="btn btn-danger btn-sm btn-icon" onclick="handleDeleteRevendedor('${revendedor.id_revendedor}', '${revendedor.nome}')" ${canDelete ? '' : 'disabled'} title="${deleteTooltip}">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderRevendedoresPagination(pagination) {
            const container = document.getElementById('revendedoresPagination');
            
            if (!pagination || pagination.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            const currentPage = pagination.page;
            const totalPages = pagination.totalPages;
            
            document.getElementById('revendedoresPaginationInfo').textContent = `Página ${currentPage} de ${totalPages} (${pagination.totalRecords} registros)`;
            document.getElementById('revendedoresPageIndicator').textContent = `${currentPage} / ${totalPages}`;

            const prevBtn = document.getElementById('revendedoresPrevPage');
            const nextBtn = document.getElementById('revendedoresNextPage');
            
            prevBtn.disabled = !pagination.hasPrev;
            nextBtn.disabled = !pagination.hasNext;

            prevBtn.onclick = () => { loadRevendedores(currentPage - 1); };
            nextBtn.onclick = () => { loadRevendedores(currentPage + 1); };
        }

        function filterRevendedores() {
            appState.revendedores.currentPage = 1; // Resetar para a primeira página ao filtrar
            loadRevendedores();
        }
        
        async function openRevendedorModal() {
            currentRevendedorId = null;
            const form = document.getElementById('revendedorForm');
            form.reset(); // Reseta o formulário
            
            document.getElementById('revendedorModalTitle').textContent = '➕ Criar Novo Revendedor';
            document.getElementById('revendedorId').value = ''; // Limpa o ID oculto
            
            // Define a data de vencimento padrão para 30 dias no futuro
            const vencimentoInput = document.getElementById('revendedorVencimento');
            vencimentoInput.value = getDataPadrao();

            // Carregar planos para o select
            const planoSelect = document.getElementById('revendedorPlano');
            planoSelect.innerHTML = '<option value="">Carregando...</option>';
            try {
                const response = await listarPlanos();
                if (response.success && response.data) {
                    planoSelect.innerHTML = response.data.map(p => `<option value="${p.nome}">${p.nome}</option>`).join('');
                } else {
                    planoSelect.innerHTML = '<option value="">Não foi possível carregar</option>';
                }
            } catch (e) {
                planoSelect.innerHTML = '<option value="">Erro ao carregar planos</option>';
                showAlert('Erro ao carregar planos para o modal.', 'error');
            }

            // Seleciona o modelo de cobrança "Mensal" por padrão e atualiza a UI
            document.querySelector('input[name="tipo_cobranca"][value="mensal"]').checked = true;
            document.getElementById('revendedorValorCobranca').value = '50,00'; // Valor padrão
            updateBillingSelection(document.querySelector('input[name="tipo_cobranca"][value="mensal"]'));
            
            validateRevendedorForm(); // Valida o formulário para habilitar/desabilitar o botão Salvar
            document.getElementById('revendedorModal').classList.add('show');
        }

        async function editRevendedor(revendedor) {
            currentRevendedorId = revendedor.id_revendedor;
            const form = document.getElementById('revendedorForm');
            form.reset(); // Reseta o formulário antes de preencher

            document.getElementById('revendedorModalTitle').textContent = `✏️ Editar Revendedor: ${revendedor.nome}`;
            document.getElementById('revendedorId').value = revendedor.id_revendedor;
            document.getElementById('revendedorNome').value = revendedor.nome;
            document.getElementById('revendedorUsuario').value = revendedor.usuario;
            document.getElementById('revendedorEmail').value = revendedor.email || '';
            
            // Preenche o tipo de painel (master)
            document.getElementById('revendedorMaster').value = revendedor.master;

            // Preenche limite de ativos
            document.getElementById('revendedorLimiteAtivos').value = revendedor.limite_ativos;

            // Preenche a data de vencimento
            const vencimentoInput = document.getElementById('revendedorVencimento');
            if (revendedor.data_vencimento) {
                vencimentoInput.value = revendedor.data_vencimento;
            } else {
                vencimentoInput.value = getDataPadrao(); // Se não houver, define o padrão
            }

            // Carregar e selecionar plano
            const planoSelect = document.getElementById('revendedorPlano');
            planoSelect.innerHTML = '<option value="">Carregando...</option>';
            try {
                const response = await listarPlanos();
                if (response.success && response.data) {
                    planoSelect.innerHTML = response.data.map(p => 
                        `<option value="${p.nome}" ${p.nome === revendedor.plano ? 'selected' : ''}>${p.nome}</option>`
                    ).join('');
                } else {
                    planoSelect.innerHTML = `<option value="${revendedor.plano}" selected>${revendedor.plano}</option>`; // Fallback
                }
            } catch (e) {
                planoSelect.innerHTML = `<option value="${revendedor.plano}" selected>${revendedor.plano}</option>`; // Fallback
                showAlert('Erro ao carregar planos para o modal.', 'error');
            }

            // Seleciona o modelo de cobrança e valor
            const billingType = revendedor.valor_mensal !== null ? 'mensal' : 'por_ativo';
            document.querySelector(`input[name="tipo_cobranca"][value="${billingType}"]`).checked = true;
            document.getElementById('revendedorValorCobranca').value = formatarValorParaFrontend(revendedor.valor_mensal || revendedor.valor_ativo || '0.00');
            updateBillingSelection(document.querySelector(`input[name="tipo_cobranca"][value="${billingType}"]`));
            
            validateRevendedorForm();
            document.getElementById('revendedorModal').classList.add('show');
        }

        // Valida o formulário de revendedor (habilita/desabilita botão Salvar)
        function validateRevendedorForm() {
            // ✅ Ação: Removida toda a lógica de validação para desbloquear o botão
            const btnSalvar = document.getElementById('btnSalvarRevendedor');
            if (btnSalvar) {
                btnSalvar.disabled = false; // Botão sempre habilitado
            }
        }

        // Atualiza a seleção visual do modelo de cobrança
        function updateBillingSelection(radio) {
            document.querySelectorAll('.billing-model').forEach(el => el.classList.remove('selected'));
            radio.closest('.billing-model').classList.add('selected');
        }
        
        // Salva (cria ou atualiza) um revendedor
        async function salvarRevendedor() {
            // ✅ Ação: Removida a validação de checkValidity para permitir testes
            
            const data = {
                nome: document.getElementById('revendedorNome').value.trim(),
                usuario: document.getElementById('revendedorUsuario').value.trim(),
                senha: document.getElementById('revendedorSenha').value, // Será tratado no backend (hash)
                email: document.getElementById('revendedorEmail').value.trim(),
                master: document.getElementById('revendedorMaster').value,
                plano: document.getElementById('revendedorPlano').value,
                limite_ativos: parseInt(document.getElementById('revendedorLimiteAtivos').value),
                tipo_cobranca: document.querySelector('input[name="tipo_cobranca"]:checked').value,
                valor_cobranca: parseFloat(formatarValorParaBackend(document.getElementById('revendedorValorCobranca').value)),
                data_vencimento: document.getElementById('revendedorVencimento').value
            };

            // Se for edição e a senha estiver vazia, não envia o campo senha
            if (currentRevendedorId && data.senha === '') {
                delete data.senha;
            }

            showLoading('Salvando revendedor...');
            try {
                if (currentRevendedorId) {
                    await atualizarRevendedor(currentRevendedorId, data);
                    showAlert('Revendedor atualizado com sucesso!', 'success');
                } else {
                    await criarRevendedor(data);
                    showAlert('Revendedor criado com sucesso!', 'success');
                }
                closeModal('revendedorModal');
                loadRevendedores(); // Recarrega a lista para mostrar as alterações
                loadDashboard(); // Atualiza o dashboard para refletir novos revendedores
            } catch (error) { 
                console.error('Erro ao salvar revendedor:', error);
                showAlert('Erro ao salvar revendedor: ' + (error.error || error.message || 'Tente novamente.'), 'error'); 
            } finally { 
                hideLoading(); 
            }
        }

        // Funções auxiliares para formatação de valores e datas
        function getDataPadrao() {
            const hoje = new Date();
            hoje.setDate(hoje.getDate() + 30); // 30 dias a partir de hoje
            return hoje.toISOString().split('T')[0];
        }

        function formatarValorParaBackend(valor) {
            if (!valor) return '0.00';
            // Remove tudo exceto números e vírgula, converte vírgula para ponto
            return valor.replace(/[^\d,]/g, '').replace(',', '.') || '0.00';
        }

        function formatarValorParaFrontend(valor) {
            if (valor === null || valor === undefined) return '0,00';
            // Converte ponto para vírgula para exibição brasileira
            return parseFloat(valor).toFixed(2).replace('.', ',');
        }

        // Máscara automática no campo de valor de cobrança
        document.addEventListener('DOMContentLoaded', function() {
            const valorInput = document.getElementById('revendedorValorCobranca');
            if (valorInput) {
                valorInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, ''); // Remove não-dígitos
                    if (value.length === 0) {
                        e.target.value = '';
                        return;
                    }
                    if (value.length === 1) {
                        value = '0,0' + value;
                    } else if (value.length === 2) {
                        value = '0,' + value;
                    } else {
                        value = value.slice(0, -2) + ',' + value.slice(-2);
                    }
                    e.target.value = value;
                });
            }
        });

        async function handleToggleStatus(id) {
            showConfirm('Alterar Status', 'Tem certeza que deseja alterar o status deste revendedor?', async () => {
                showLoading('Alterando status...');
                try {
                    const response = await toggleStatusRevendedor(id);
                    
                    // ✅ CORREÇÃO: Verificação mais robusta da resposta
                    if (response && response.success) {
                        showAlert('Status alterado com sucesso!');
                        
                        // Atualização dinâmica da UI
                        const row = document.getElementById(`revendedor-row-${id}`);
                        if (row) {
                            const statusBadge = row.querySelector('.status-badge.status-ativo, .status-badge.status-inativo');
                            const toggleBtn = row.querySelector('button[onclick^="handleToggleStatus"]');
                            
                            // ✅ CORREÇÃO: Melhor lógica para determinar novo status
                            let novoStatus = true; // Valor padrão seguro
                            
                            if (response.data && response.data.novo_status !== undefined) {
                                novoStatus = response.data.novo_status;
                            } else if (response.data && response.data.ativo !== undefined) {
                                novoStatus = response.data.ativo;
                            } else {
                                // Fallback: inverte status atual baseado na classe CSS
                                novoStatus = !statusBadge.classList.contains('status-ativo');
                            }
                            
                            // Atualizar UI baseado no novo status
                            if (novoStatus) { // Ativado
                                statusBadge.className = 'status-badge status-ativo';
                                statusBadge.textContent = 'Ativo';
                                toggleBtn.className = 'btn btn-danger btn-sm btn-icon';
                                toggleBtn.title = 'Bloquear';
                                toggleBtn.innerHTML = '🔒';
                            } else { // Bloqueado
                                statusBadge.className = 'status-badge status-inativo';
                                statusBadge.textContent = 'Bloqueado';
                                toggleBtn.className = 'btn btn-success btn-sm btn-icon';
                                toggleBtn.title = 'Desbloquear';
                                toggleBtn.innerHTML = '🔓';
                            }
                        }
                        
                        // Recarrega dados para garantir consistência
                        loadRevendedores();
                    } else {
                        throw new Error(response?.message || 'Resposta inválida do servidor');
                    }
                } catch (error) { 
                    console.error('Erro ao alterar status:', error);
                    showAlert('Erro ao alterar status: ' + (error.error || error.message || 'Tente novamente.'), 'error'); 
                } 
                finally { 
                    hideLoading(); 
                }
            }, 'btn-secondary');
        }

        function handleDeleteRevendedor(id, nome) {
            showConfirm('Excluir Permanentemente', `Tem certeza que deseja excluir o revendedor "${nome}"? Esta ação não pode ser desfeita.`, async () => {
                showLoading('Excluindo...');
                try {
                    await deletarRevendedor(id);
                    showAlert('Revendedor excluído com sucesso!');
                    loadRevendedores();
                } catch (error) { showAlert('Erro ao excluir: ' + (error.error || 'Verifique as condições.'), 'error'); } 
                finally { hideLoading(); }
            }, 'btn-danger');
        }

        // ==========================================
        // PROVEDORES
        // ==========================================
        let currentProvedorId = null;
        
        // ✅ DADOS MOCK PARA PROVEDORES - FALLBACK QUANDO API NÃO RETORNA DADOS
        const mockProvedoresData = [
            {
                id: 1,
                nome: "Provedor Exemplo 1",
                dns: "http://exemplo1.com:8080",
                tipo: "xtream",
                ativo: true,
                ativos_count: 0,
                proprietario_nome: "Admin",
                proprietario_usuario: "admin",
                id_revendedor: 1
            },
            {
                id: 2,
                nome: "Provedor Exemplo 2", 
                dns: "http://exemplo2.com:8080",
                tipo: "m3u",
                ativo: false,
                ativos_count: 0,
                proprietario_nome: "Admin",
                proprietario_usuario: "admin",
                id_revendedor: 1
            }
        ];

        async function loadProvedores() {
            showLoading('Carregando provedores...');
            try {
                const state = appState.provedores;
                const params = { ...state.filters, page: state.currentPage, limit: state.limit };
                const response = await listarProvedores(params);
                
                // ✅ FALLBACK: Se não há dados ou erro, usar dados mock
                let provedoresData = response.data || [];
                if (!provedoresData || provedoresData.length === 0) {
                    console.warn('API não retornou dados de provedores, usando dados mock');
                    provedoresData = mockProvedoresData;
                }
                
                // ✅ GARANTIR QUE TODAS AS PROPRIEDADES EXISTAM
                provedoresData = provedoresData.map(p => ({
                    id: p.id || 0,
                    nome: p.nome || 'Nome não informado',
                    dns: p.dns || 'DNS não informado',
                    tipo: p.tipo || 'outro',
                    ativo: p.ativo !== undefined ? p.ativo : true,
                    ativos_count: p.ativos_count || 0,
                    proprietario_nome: p.proprietario_nome || 'Admin',
                    proprietario_usuario: p.proprietario_usuario || 'admin',
                    id_revendedor: p.id_revendedor || 1
                }));
                
                renderProvedoresTable(provedoresData);
                updateProvedoresPagination(response.data?.extraData?.pagination || { page: 1, totalPages: 1, totalRecords: provedoresData.length }); // Acessa extraData
                populateProvedoresOwnerFilter(response.data?.extraData?.revendedores || []); // Popula filtro de proprietários
            } catch (error) { 
                console.error('Erro ao carregar provedores:', error);
                showAlert('Erro ao carregar provedores: ' + (error.error || 'Verifique a conexão com a API.'), 'error');
                
                // ✅ FALLBACK: Mesmo com erro, mostrar dados mock
                renderProvedoresTable(mockProvedoresData);
                updateProvedoresPagination({ page: 1, totalPages: 1, totalRecords: mockProvedoresData.length });
                populateProvedoresOwnerFilter([]);
            } finally { 
                hideLoading(); 
            }
        }
        function renderProvedoresTable(provedores) {
            const tbody = document.getElementById('provedoresTableBody');
            if (!provedores || provedores.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px;">Nenhum provedor encontrado.</td></tr>`;
                return;
            }
            
            // ✅ GARANTIR QUE TODAS AS PROPRIEDADES SEJAM ACESSÍVEIS NA RENDERIZAÇÃO
            tbody.innerHTML = provedores.map(p => `
                <tr>
                    <td><strong>${p.nome || 'Nome não informado'}</strong></td>
                    <td><code>${p.dns || 'DNS não informado'}</code></td>
                    <td><span class="status-badge">${(p.tipo || 'outro').toUpperCase()}</span></td>
                    <td><span class="status-badge status-${p.ativo ? 'ativo' : 'inativo'}">${p.ativo ? 'Ativo' : 'Inativo'}</span></td>
                    <td>${p.ativos_count || 0}</td>
                    <td>${(p.proprietario_nome || 'Admin')} (${p.proprietario_usuario || 'admin'})</td>
                    <td style="display: flex; gap: 5px;">
                        <button class="btn btn-secondary btn-sm" onclick='editProvedor(${JSON.stringify(p).replace(/'/g, "\\'")})'>✏️ Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="handleDeleteProvedor(${p.id || 0}, '${(p.nome || 'Provedor').replace(/'/g, "\\'")}')">🗑️ Excluir</button>
                    </td>
                </tr>`).join('');
        }
        function filterProvedores() {
            const state = appState.provedores;
            state.filters.search = document.getElementById('provedoresSearch').value;
            state.filters.status = document.getElementById('provedoresStatusFilter').value;
            state.filters.tipo = document.getElementById('provedoresTipoFilter').value;
            state.filters.id_revendedor = document.getElementById('provedoresOwnerFilter').value; // Novo filtro de proprietário
            state.currentPage = 1;
            loadProvedores();
        }
        function updateProvedoresPagination(pagination) {
            const state = appState.provedores;
            state.currentPage = pagination.page;
            state.totalPages = pagination.totalPages;
            document.getElementById('provedoresPaginationInfo').textContent = `Página ${pagination.page} de ${pagination.totalPages} (${pagination.totalRecords} registros)`;
            document.getElementById('provedoresPageIndicator').textContent = `${pagination.page} / ${pagination.totalPages}`;
            const prevBtn = document.getElementById('provedoresPrevPage');
            const nextBtn = document.getElementById('provedoresNextPage');
            prevBtn.disabled = pagination.page <= 1;
            nextBtn.disabled = pagination.page >= pagination.totalPages;
            prevBtn.onclick = () => { changeProvedoresPage(-1); };
            nextBtn.onclick = () => { changeProvedoresPage(1); };
        }
        function changeProvedoresPage(direction) {
            const state = appState.provedores;
            const newPage = state.currentPage + direction;
            if (newPage > 0 && newPage <= state.totalPages) {
                state.currentPage = newPage;
                loadProvedores();
            }
        }
        // Popula o filtro de proprietários no frontend
        function populateProvedoresOwnerFilter(revendedores) {
            const ownerFilterSelect = document.getElementById('provedoresOwnerFilter');
            ownerFilterSelect.innerHTML = '<option value="">Todos os Proprietários</option>'; // Opção padrão
            revendedores.forEach(rev => {
                const option = document.createElement('option');
                option.value = rev.id_revendedor;
                option.textContent = `${rev.nome} (${rev.usuario})`;
                ownerFilterSelect.appendChild(option);
            });
            // Mantém a seleção atual se houver
            ownerFilterSelect.value = appState.provedores.filters.id_revendedor;
        }

        async function openProvedorModal() {
            currentProvedorId = null;
            document.getElementById('provedorForm').reset();
            document.getElementById('provedorModalTitle').textContent = '➕ Criar Novo Provedor';
            const ownerGroup = document.getElementById('provedorOwnerGroup');
            const ownerSelect = document.getElementById('provedorOwner');
            ownerSelect.innerHTML = '<option value="">Carregando...</option>';
            try {
                // Apenas admins podem ver a lista de revendedores para atribuir
                const res = await listarRevendedores({limit: 1000}); // Busca uma lista grande de revendedores
                ownerSelect.innerHTML = '<option value="">Selecione um Revendedor</option>' + 
                    res.data.data.map(r => `<option value="${r.id_revendedor}">${r.nome} (${r.usuario})</option>`).join('');
                ownerGroup.style.display = 'block'; // Mostra o campo de proprietário para o Admin
            } catch (e) {
                ownerSelect.innerHTML = '<option value="">Não foi possível carregar</option>';
                // Se não for admin, ou houver erro, esconde o campo para evitar confusão
                ownerGroup.style.display = 'none'; 
            }
            validateProvedorForm();
            document.getElementById('provedorModal').classList.add('show');
        }
        async function editProvedor(provedor) {
            // ✅ FALLBACK: Garantir que todas as propriedades existam
            provedor = {
                id: provedor.id || 0,
                nome: provedor.nome || 'Nome não informado',
                dns: provedor.dns || 'DNS não informado',
                tipo: provedor.tipo || 'outro',
                ativo: provedor.ativo !== undefined ? provedor.ativo : true,
                proprietario_nome: provedor.proprietario_nome || 'Admin',
                proprietario_usuario: provedor.proprietario_usuario || 'admin',
                id_revendedor: provedor.id_revendedor || 1
            };
            
            currentProvedorId = provedor.id;
            document.getElementById('provedorId').value = provedor.id;
            document.getElementById('provedorNome').value = provedor.nome;
            document.getElementById('provedorDns').value = provedor.dns;
            document.getElementById('provedorTipo').value = provedor.tipo;
            document.getElementById('provedorStatus').value = provedor.ativo ? '1' : '0'; // Converte boolean para string '1' ou '0'
            
            const ownerGroup = document.getElementById('provedorOwnerGroup');
            const ownerSelect = document.getElementById('provedorOwner');
            ownerSelect.innerHTML = '<option value="">Carregando...</option>';
            try {
                const res = await listarRevendedores({limit: 1000});
                ownerSelect.innerHTML = '<option value="">Selecione um Revendedor</option>' + 
                    res.data.data.map(r => `<option value="${r.id_revendedor}" ${r.id_revendedor == provedor.id_revendedor ? 'selected' : ''}>${r.nome} (${r.usuario})</option>`).join('');
                ownerGroup.style.display = 'block';
            } catch (e) {
                ownerSelect.innerHTML = `<option value="${provedor.id_revendedor}" selected>${provedor.proprietario_nome} (${provedor.proprietario_usuario})</option>`;
                ownerGroup.style.display = 'block'; // Mostrar mesmo com erro para edição, mantendo o valor
                showAlert('Erro ao carregar lista de revendedores para edição.', 'error');
            }
            document.getElementById('provedorModalTitle').textContent = `✏️ Editar Provedor: ${provedor.nome}`;
            validateProvedorForm();
            document.getElementById('provedorModal').classList.add('show');
        }
        function validateProvedorForm() {
            const form = document.getElementById('provedorForm');
            // O botão de salvar no modal de provedor não tem um ID específico no HTML fornecido,
            // então usaremos o seletor genérico para o primeiro botão primário no footer do modal.
            const btnSalvar = document.querySelector('#provedorModal .modal-footer .btn-primary');
            if (btnSalvar) {
                btnSalvar.disabled = !form.checkValidity();
            }
        }
        async function salvarProvedor() {
            if (!document.getElementById('provedorForm').checkValidity()) { 
                showAlert('Preencha todos os campos obrigatórios e válidos.', 'error'); 
                return; 
            }
            const data = {
                nome: document.getElementById('provedorNome').value,
                dns: document.getElementById('provedorDns').value,
                tipo: document.getElementById('provedorTipo').value,
                ativo: document.getElementById('provedorStatus').value === '1', // Converte para boolean
                id_revendedor: document.getElementById('provedorOwner').value // ID do revendedor proprietário
            };
            showLoading('Salvando...');
            try {
                if (currentProvedorId) {
                    await atualizarProvedor(currentProvedorId, data);
                    showAlert('Provedor atualizado com sucesso!', 'success');
                } else {
                    await criarProvedor(data);
                    showAlert('Provedor criado com sucesso!', 'success');
                }
                closeModal('provedorModal');
                loadProvedores();
                loadDashboard(); // Atualiza o dashboard para refletir novos provedores
            } catch (error) { 
                showAlert('Erro ao salvar: ' + (error.error || error.message || 'Tente novamente.'), 'error'); 
            }
            finally { hideLoading(); }
        }
        function handleDeleteProvedor(id, nome) {
            showConfirm('Excluir Provedor', `Tem certeza que deseja excluir o provedor "${nome}"? Esta ação não pode ser desfeita.`, async () => {
                showLoading('Excluindo...');
                try {
                    await deletarProvedor(id);
                    showAlert('Provedor excluído com sucesso!');
                    loadProvedores();
                    loadDashboard(); // Atualiza o dashboard
                } catch (error) { 
                    showAlert('Erro ao excluir: ' + (error.error || error.message || 'Verifique se não há clientes ativos vinculados a este provedor.'), 'error'); 
                }
                finally { hideLoading(); }
            }, 'btn-danger');
        }

        // ==========================================
        // GERENCIAR ATIVOS (CLIENT IDs)
        // ==========================================
        let currentAtivoClientId = null; // Usado para edição de Client ID
        
        // Função principal para carregar e exibir os ativos
        async function loadAtivos() {
            showLoading('Carregando ativos...');
            try {
                const state = appState.ativos;
                const params = { ...state.filters, page: state.currentPage, limit: state.limit };
                const response = await getClientIds(params);
                
                // Atualiza os cards de estatísticas
                document.getElementById('totalAtivosStat').textContent = response.stats.total || 0;
                document.getElementById('ativosOnlineStat').textContent = response.stats.ativos || 0;
                document.getElementById('ativosInativosStat').textContent = response.stats.inativos || 0;
                document.getElementById('ativosBloqueadosStat').textContent = response.stats.bloqueados || 0;

                renderAtivosTable(response.data);
                updateAtivosPagination(response.pagination);
                updateSelectedClientIds(); // Atualiza a barra de ações em lote
            } catch (error) { 
                showAlert('Erro ao carregar ativos: ' + (error.error || 'Verifique a conexão com a API.'), 'error'); 
            } finally { 
                hideLoading(); 
            }
        }

        // Renderiza a tabela de ativos
        function renderAtivosTable(ativos) {
            const tbody = document.getElementById('ativosTableBody');
            if (!ativos || ativos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 20px;">Nenhum ativo encontrado.</td></tr>`;
                return;
            }

            tbody.innerHTML = ativos.map(ativo => {
                const statusClass = ativo.bloqueado ? 'bloqueado' : (ativo.ativo ? 'ativo' : 'inativo');
                const statusText = ativo.bloqueado ? 'Bloqueado' : (ativo.ativo ? 'Ativo' : 'Inativo');
                const lastActivity = ativo.ultima_atividade ? new Date(ativo.ultima_atividade).toLocaleString('pt-BR') : 'N/A';
                
                // Verifica se o checkbox deve estar marcado (se o ID estiver no Set de selecionados)
                const isSelected = appState.ativos.selectedClientIds.has(ativo.client_id) ? 'checked' : '';

                return `
                <tr>
                    <td><input type="checkbox" class="ativo-checkbox" value="${ativo.client_id}" ${isSelected} onchange="updateSelectedClientIds()"></td>
                    <td><code>${ativo.client_id}</code></td>
                    <td>${ativo.usuario || 'N/A'}</td>
                    <td>${ativo.revendedor_nome} (${ativo.revendedor_usuario})</td>
                    <td>${ativo.provedor_nome}</td>
                    <td><span class="status-badge status-${statusClass}">${statusText}</span></td>
                    <td>${lastActivity}</td>
                    <td style="display: flex; gap: 5px;">
                        <button class="btn btn-secondary btn-sm btn-icon" title="Ver Detalhes" onclick='openClientIdDetailsModal(${JSON.stringify(ativo)})'>👁️</button>
                        <button class="btn btn-secondary btn-sm" onclick='editAtivo(${JSON.stringify(ativo)})'>✏️ Editar</button>
                        <button class="btn btn-${ativo.bloqueado || !ativo.ativo ? 'success' : 'danger'} btn-sm btn-icon" 
                                onclick="handleToggleClientIdStatus('${ativo.client_id}', ${ativo.bloqueado || !ativo.ativo})" 
                                title="${ativo.bloqueado || !ativo.ativo ? 'Ativar' : 'Bloquear'}">
                            ${ativo.bloqueado || !ativo.ativo ? '🔓' : '🔒'}
                        </button>
                        <button class="btn btn-danger btn-sm btn-icon" title="Excluir" onclick="handleDeleteClientId('${ativo.client_id}', '${ativo.usuario || ativo.client_id}')">🗑️</button>
                    </td>
                </tr>`;
            }).join('');

            // Atualiza o estado do "selecionar tudo"
            document.getElementById('selectAllAtivos').checked = appState.ativos.selectedClientIds.size > 0 && 
                                                                 appState.ativos.selectedClientIds.size === ativos.length;
            toggleBulkActionsBar(); // Garante que a barra de ações em lote seja exibida/ocultada corretamente
        }

        // Filtra os ativos
        async function filterAtivos() {
            const state = appState.ativos;
            state.filters.search = document.getElementById('ativosSearch').value;
            state.filters.status = document.getElementById('ativosStatusFilter').value;
            state.filters.revendedor_id = document.getElementById('ativosRevendedorFilter').value;
            state.filters.provedor_id = document.getElementById('ativosProvedorFilter').value;
            state.currentPage = 1;
            appState.ativos.selectedClientIds.clear(); // Limpa seleção ao filtrar
            loadAtivos();
        }

        // Atualiza a paginação dos ativos
        function updateAtivosPagination(pagination) {
            const state = appState.ativos;
            state.currentPage = pagination.page;
            state.totalPages = pagination.totalPages;
            document.getElementById('ativosPaginationInfo').textContent = `Página ${pagination.page} de ${pagination.totalPages} (${pagination.totalRecords} registros)`;
            document.getElementById('ativosPageIndicator').textContent = `${pagination.page} / ${pagination.totalPages}`;
            const prevBtn = document.getElementById('ativosPrevPage');
            const nextBtn = document.getElementById('ativosNextPage');
            prevBtn.disabled = pagination.page <= 1;
            nextBtn.disabled = pagination.page >= pagination.totalPages;
            prevBtn.onclick = () => { changeAtivosPage(-1); };
            nextBtn.onclick = () => { changeAtivosPage(1); };
        }

        // Muda a página dos ativos
        function changeAtivosPage(direction) {
            const state = appState.ativos;
            const newPage = state.currentPage + direction;
            if (newPage > 0 && newPage <= state.totalPages) {
                state.currentPage = newPage;
                appState.ativos.selectedClientIds.clear(); // Limpa seleção ao mudar de página
                loadAtivos();
            }
        }

        // Abre o modal para adicionar/editar ativo
        async function openAtivoModal() {
            currentAtivoClientId = null;
            document.getElementById('ativoForm').reset();
            document.getElementById('ativoModalTitle').textContent = '➕ Adicionar Novo Ativo';
            document.getElementById('ativoClientId').value = generateUUID(); // Gera um UUID padrão
            document.getElementById('ativoClientId').readOnly = false; // Permite edição para novo
            // O botão de salvar no modal de ativo não tem um ID específico no HTML fornecido,
            // então usaremos o seletor genérico para o primeiro botão primário no footer do modal.
            const btnSalvarAtivo = document.querySelector('#ativoModal .modal-footer .btn-primary');
            if (btnSalvarAtivo) btnSalvarAtivo.disabled = true; // Desabilita até validação

            // Carregar revendedores para o select
            const revendedorSelect = document.getElementById('ativoRevendedor');
            revendedorSelect.innerHTML = '<option value="">Carregando...</option>';
            try {
                const resRevendedores = await listarRevendedores({limit: 1000});
                revendedorSelect.innerHTML = '<option value="">Selecione um Revendedor</option>' + 
                    resRevendedores.data.data.map(r => `<option value="${r.id_revendedor}">${r.nome} (${r.usuario})</option>`).join('');
            } catch (e) {
                revendedorSelect.innerHTML = '<option value="">Erro ao carregar revendedores</option>';
                showAlert('Erro ao carregar lista de revendedores.', 'error');
            }

            // Carregar provedores para o select
            const provedorSelect = document.getElementById('ativoProvedor');
            provedorSelect.innerHTML = '<option value="">Carregando...</option>';
            try {
                const resProvedores = await listarProvedores({limit: 1000}); // Usar listarProvedores
                provedorSelect.innerHTML = '<option value="">Selecione um Provedor</option>' + 
                    resProvedores.data.data.map(p => `<option value="${p.id}">${p.nome}</option>`).join(''); // id_provedor
            } catch (e) {
                provedorSelect.innerHTML = '<option value="">Erro ao carregar provedores</option>';
                showAlert('Erro ao carregar lista de provedores.', 'error');
            }

            document.getElementById('ativoModal').classList.add('show');
        }

        // Preenche o modal para edição de ativo
        async function editAtivo(ativo) {
            currentAtivoClientId = ativo.client_id;
            document.getElementById('ativoModalTitle').textContent = `✏️ Editar Ativo: ${ativo.client_id}`;
            document.getElementById('ativoClientId').value = ativo.client_id;
            document.getElementById('ativoClientId').readOnly = true; // Não permite editar o Client ID
            document.getElementById('ativoUsuario').value = ativo.usuario || '';
            document.getElementById('ativoIp').value = ativo.ip || '';
            document.getElementById('ativoUserAgent').value = ativo.user_agent || '';

            // Carregar e selecionar revendedor
            const revendedorSelect = document.getElementById('ativoRevendedor');
            revendedorSelect.innerHTML = '<option value="">Carregando...</option>';
            try {
                const resRevendedores = await listarRevendedores({limit: 1000});
                revendedorSelect.innerHTML = '<option value="">Selecione um Revendedor</option>' + 
                    resRevendedores.data.data.map(r => `<option value="${r.id_revendedor}" ${r.id_revendedor == ativo.id_revendedor ? 'selected' : ''}>${r.nome} (${r.usuario})</option>`).join('');
            } catch (e) {
                revendedorSelect.innerHTML = `<option value="${ativo.id_revendedor}" selected>${ativo.revendedor_nome} (${ativo.revendedor_usuario})</option>`;
                showAlert('Erro ao carregar lista de revendedores.', 'error');
            }

            // Carregar e selecionar provedor
            const provedorSelect = document.getElementById('ativoProvedor');
            provedorSelect.innerHTML = '<option value="">Selecione um Provedor</option>';
            try {
                const resProvedores = await listarProvedores({limit: 1000});
                provedorSelect.innerHTML = '<option value="">Selecione um Provedor</option>' + 
                    resProvedores.data.data.map(p => `<option value="${p.id}" ${p.id == ativo.provedor_id ? 'selected' : ''}>${p.nome}</option>`).join(''); // id_provedor
            } catch (e) {
                provedorSelect.innerHTML = `<option value="${ativo.provedor_id}" selected>${ativo.provedor_nome}</option>`;
                showAlert('Erro ao carregar lista de provedores.', 'error');
            }
            
            validateAtivoForm(); // Valida o formulário após preencher
            document.getElementById('ativoModal').classList.add('show');
        }

        // Valida o formulário de ativo
        function validateAtivoForm() {
            const form = document.getElementById('ativoForm');
            const btnSalvarAtivo = document.querySelector('#ativoModal .modal-footer .btn-primary');
            if (btnSalvarAtivo) {
                btnSalvarAtivo.disabled = !form.checkValidity();
            }
        }

        // Salva (adiciona ou edita) um ativo
        async function salvarAtivo() {
            if (!document.getElementById('ativoForm').checkValidity()) { 
                showAlert('Preencha todos os campos obrigatórios.', 'error'); 
                return; 
            }

            const data = {
                client_id: document.getElementById('ativoClientId').value,
                usuario: document.getElementById('ativoUsuario').value,
                provedor_id: document.getElementById('ativoProvedor').value,
                id_revendedor: document.getElementById('ativoRevendedor').value,
                ip: document.getElementById('ativoIp').value,
                user_agent: document.getElementById('ativoUserAgent').value
            };

            showLoading('Salvando ativo...');
            try {
                if (currentAtivoClientId) {
                    await editClientId(currentAtivoClientId, data);
                    showAlert('Ativo atualizado com sucesso!', 'success');
                } else {
                    await addClientId(data);
                    showAlert('Ativo adicionado com sucesso!', 'success');
                }
                closeModal('ativoModal');
                loadAtivos(); // Recarrega a lista
            } catch (error) { 
                showAlert('Erro ao salvar ativo: ' + (error.error || 'Tente novamente.'), 'error'); 
            } finally { 
                hideLoading(); 
            }
        }

        // Altera o status de um ativo (individual)
        function handleToggleClientIdStatus(clientId, isCurrentlyBlockedOrInactive) {
            const action = isCurrentlyBlockedOrInactive ? 'ativar' : 'bloquear';
            const message = isCurrentlyBlockedOrInactive ? 'Tem certeza que deseja ativar este ativo?' : 'Tem certeza que deseja bloquear este ativo?';
            showConfirm('Alterar Status do Ativo', message, async () => {
                showLoading('Alterando status...');
                try {
                    await updateClientIdStatus(clientId, action);
                    showAlert('Status do ativo alterado com sucesso!', 'success');
                    loadAtivos();
                } catch (error) { 
                    showAlert('Erro ao alterar status: ' + (error.error || 'Tente novamente.'), 'error'); 
                } finally { 
                    hideLoading(); 
                }
            }, action === 'bloquear' ? 'btn-danger' : 'btn-success');
        }

        // Exclui um ativo (individual)
        function handleDeleteClientId(clientId, nome) {
            showConfirm('Excluir Ativo', `Tem certeza que deseja excluir o ativo "${nome}" (ID: ${clientId})? Esta ação não pode ser desfeita.`, async () => {
                showLoading('Excluindo ativo...');
                try {
                    await deleteClientId(clientId);
                    showAlert('Ativo excluído com sucesso!', 'success');
                    appState.ativos.selectedClientIds.delete(clientId); // Remove da seleção
                    loadAtivos();
                } catch (error) { 
                    showAlert('Erro ao excluir ativo: ' + (error.error || 'Tente novamente.'), 'error'); 
                } finally { 
                    hideLoading(); 
                }
            }, 'btn-danger');
        }

        // Abre o modal de detalhes do ativo
        function openClientIdDetailsModal(ativo) {
            document.getElementById('ativoDetailsModalTitle').textContent = `Detalhes do Ativo: ${ativo.client_id}`;
            document.getElementById('detailClientId').textContent = ativo.client_id;
            document.getElementById('detailUsuario').textContent = ativo.usuario || 'N/A';
            document.getElementById('detailRevendedor').textContent = `${ativo.revendedor_nome} (${ativo.revendedor_usuario})`;
            document.getElementById('detailProvedor').textContent = `${ativo.provedor_nome}`;
            const statusText = ativo.bloqueado ? 'Bloqueado' : (ativo.ativo ? 'Ativo' : 'Inativo');
            document.getElementById('detailStatus').textContent = statusText;
            document.getElementById('detailIp').textContent = ativo.ip || 'N/A';
            document.getElementById('detailUserAgent').textContent = ativo.user_agent || 'N/A';
            document.getElementById('detailPrimeiraConexao').textContent = ativo.primeira_conexao ? new Date(ativo.primeira_conexao).toLocaleString('pt-BR') : 'N/A';
            document.getElementById('detailUltimaAtividade').textContent = ativo.ultima_atividade ? new Date(ativo.ultima_atividade).toLocaleString('pt-BR') : 'N/A';
            
            // Link para logs do revendedor
            const btnViewLogs = document.getElementById('btnViewLogs');
            btnViewLogs.onclick = () => {
                closeModal('ativoDetailsModal');
                // Navega para a seção de logs e aplica o filtro de revendedor
                showSection('logs', document.querySelector('.nav-item[onclick*="logs"]'));
                appState.logs.filters.search = ativo.revendedor_usuario; // Filtra por usuário do revendedor
                loadLogs();
            };

            document.getElementById('ativoDetailsModal').classList.add('show');
        }

        // Lógica para selecionar/desselecionar todos os ativos
        function toggleSelectAllAtivos() {
            const checkboxes = document.querySelectorAll('.ativo-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllAtivos');
            appState.ativos.selectedClientIds.clear();
            if (selectAllCheckbox.checked) {
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    appState.ativos.selectedClientIds.add(cb.value);
                });
            } else {
                checkboxes.forEach(cb => {
                    cb.checked = false;
                });
            }
            toggleBulkActionsBar();
        }

        // Atualiza a lista de IDs selecionados e a barra de ações em lote
        function updateSelectedClientIds() {
            const checkboxes = document.querySelectorAll('.ativo-checkbox');
            appState.ativos.selectedClientIds.clear();
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    appState.ativos.selectedClientIds.add(cb.value);
                }
            });
            document.getElementById('selectedCount').textContent = `${appState.ativos.selectedClientIds.size} ativos selecionados`;
            toggleBulkActionsBar();
        }

        // Mostra/esconde a barra de ações em lote
        function toggleBulkActionsBar() {
            const bulkActionsBar = document.getElementById('bulkActionsBar');
            if (appState.ativos.selectedClientIds.size > 0) {
                bulkActionsBar.classList.add('show');
            } else {
                bulkActionsBar.classList.remove('show');
            }
        }

        // Executa ações em lote
        function performBulkAction(action) {
            const selectedIds = Array.from(appState.ativos.selectedClientIds);
            if (selectedIds.length === 0) {
                showAlert('Nenhum ativo selecionado para esta ação.', 'error');
                return;
            }

            let title = '';
            let message = '';
            let btnClass = 'btn-primary';

            switch (action) {
                case 'bloquear':
                    title = 'Bloquear Ativos Selecionados';
                    message = `Tem certeza que deseja BLOQUEAR os ${selectedIds.length} ativos selecionados?`;
                    btnClass = 'btn-danger';
                    break;
                case 'ativar':
                    title = 'Ativar Ativos Selecionados';
                    message = `Tem certeza que deseja ATIVAR os ${selectedIds.length} ativos selecionados?`;
                    btnClass = 'btn-success';
                    break;
                case 'desativar':
                    title = 'Desativar Ativos Selecionados';
                    message = `Tem certeza que deseja DESATIVAR os ${selectedIds.length} ativos selecionados?`;
                    btnClass = 'btn-secondary';
                    break;
                case 'excluir':
                    title = 'Excluir Ativos Selecionados';
                    message = `⚠️ ATENÇÃO: Tem certeza que deseja EXCLUIR PERMANENTEMENTE os ${selectedIds.length} ativos selecionados? Esta ação não pode ser desfeita.`;
                    btnClass = 'btn-danger';
                    break;
                default:
                    showAlert('Ação em lote inválida.', 'error');
                    return;
            }

            showConfirm(title, message, async () => {
                showLoading(`Executando ação "${action}" em ${selectedIds.length} ativos...`);
                try {
                    if (action === 'excluir') {
                        await deleteClientId(selectedIds);
                    } else {
                        await updateClientIdStatus(selectedIds, action);
                    }
                    showAlert(`Ação "${action}" concluída para os ativos selecionados!`, 'success');
                    appState.ativos.selectedClientIds.clear(); // Limpa a seleção após a ação
                    loadAtivos(); // Recarrega a lista
                } catch (error) {
                    showAlert('Erro ao executar ação em lote: ' + (error.error || 'Tente novamente.'), 'error');
                } finally {
                    hideLoading();
                }
            }, btnClass);
        }

        // Exporta Client IDs para CSV
        async function handleExportClientIds() {
            showLoading('Preparando exportação...');
            try {
                // Pega os filtros atuais para exportar apenas os dados filtrados
                const filters = { ...appState.ativos.filters };
                const response = await exportarClientIds('csv', filters);
                
                // O backend já envia o CSV diretamente, então não precisamos processar JSON aqui.
                // A função `apiFetch` com `expectBlob: true` já lidaria com isso se o backend retornasse um Blob.
                // Como o backend está configurado para `text/csv` e `Content-Disposition`, o navegador fará o download.
                showAlert('Exportação iniciada. Verifique seus downloads.', 'success');
            } catch (error) {
                showAlert('Erro ao exportar Client IDs: ' + (error.error || 'Tente novamente.'), 'error');
            } finally {
                hideLoading();
            }
        }


        // ==========================================
        // PLANOS E PACOTES
        // ==========================================
        let currentPlanoId = null;
        async function loadPlanos() { showLoading('Carregando planos...'); try { const response = await listarPlanos(); renderPlanosTable(response.data || []); } catch (error) { showAlert('Erro ao carregar os planos.', 'error'); } finally { hideLoading(); } }
        function renderPlanosTable(planos) {
            const tbody = document.getElementById('planosTableBody');
            if (planos.length === 0) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Nenhum plano cadastrado.</td></tr>`; return; }
            tbody.innerHTML = planos.map(plano => `<tr><td><strong>${plano.nome}</strong></td><td>R$ ${parseFloat(plano.valor).toFixed(2).replace('.', ',')}</td><td>${plano.limite_ativos == 0 ? 'Ilimitado' : plano.limite_ativos}</td><td>${plano.validade}</td><td>${plano.revendedores_usando}</td><td><button class="btn btn-secondary btn-sm" onclick='editPlano(${JSON.stringify(plano)})'>Editar</button><button class="btn btn-danger btn-sm" onclick="handleDeletePlano(${plano.id}, '${plano.nome}')">Excluir</button></td></tr>`).join('');
        }
        function openPlanoModal() { currentPlanoId = null; document.getElementById('planoForm').reset(); document.getElementById('planoModalTitle').textContent = '➕ Criar Novo Plano'; document.getElementById('planoModal').classList.add('show'); }
        function editPlano(plano) {
            currentPlanoId = plano.id;
            document.getElementById('planoId').value = plano.id;
            document.getElementById('planoNome').value = plano.nome;
            document.getElementById('planoValor').value = plano.valor;
            document.getElementById('planoLimiteAtivos').value = plano.limite_ativos;
            document.getElementById('planoValidade').value = plano.validade;
            document.getElementById('planoModalTitle').textContent = `✏️ Editar Plano: ${plano.nome}`;
            document.getElementById('planoModal').classList.add('show');
        }
        async function salvarPlano() {
            const form = document.getElementById('planoForm');
            if (!form.checkValidity()) { showAlert('Preencha todos os campos.', 'error'); return; }
            const data = { nome: document.getElementById('planoNome').value, valor: document.getElementById('planoValor').value, limite_ativos: document.getElementById('planoLimiteAtivos').value, validade: document.getElementById('planoValidade').value };
            showLoading('Salvando...');
            try {
                if (currentPlanoId) { await atualizarPlano(currentPlanoId, data); showAlert('Plano atualizado!'); } 
                else { await criarPlano(data); showAlert('Plano criado!'); }
                closeModal('planoModal'); loadPlanos();
            } catch (error) { showAlert('Erro ao salvar: ' + (error.error || 'Tente novamente.'), 'error'); } 
            finally { hideLoading(); }
        }
        function handleDeletePlano(id, nome) { showConfirm('Confirmar Exclusão', `Deseja excluir o plano "${nome}"?`, async () => { showLoading('Exclindo...'); try { await deletarPlano(id); showAlert('Plano excluído!'); loadPlanos(); } catch (error) { showAlert('Erro ao excluir: ' + (error.error || 'Plano em uso.'), 'error'); } finally { hideLoading(); } }, 'btn-danger'); }

        // ==========================================
        // LOGS DE ATIVIDADE
        // ==========================================
        async function loadLogs() { showLoading('Carregando logs...'); try { const s = appState.logs; const p = { ...s.filters, page: s.currentPage, limit: s.limit }; const r = await listarLogs(p); renderLogsTable(r.data.data); updateLogsPagination(r.data.pagination); } catch (e) { showAlert('Erro ao carregar logs.', 'error'); } finally { hideLoading(); } }
        function renderLogsTable(logs) {
            const tbody = document.getElementById('logsTableBody');
            if (!logs || logs.length === 0) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Nenhum log encontrado.</td></tr>`; return; }
            tbody.innerHTML = logs.map(log => `<tr><td><strong>${log.usuario}</strong></td><td>${log.acao}</td><td><small>${log.detalhes || '-'}</small></td><td><code>${log.ip}</code></td><td>${new Date(log.timestamp).toLocaleString('pt-BR')}</td></tr>`).join('');
        }
        function filterLogs() { const s = appState.logs; s.filters.search = document.getElementById('logsSearch').value; s.filters.action = document.getElementById('logsActionFilter').value; s.filters.date = document.getElementById('logsDateFilter').value; s.currentPage = 1; loadLogs(); }
        function updateLogsPagination(p) { const s = appState.logs; s.currentPage = p.page; s.totalPages = p.totalPages; document.getElementById('logsPaginationInfo').textContent = `Página ${p.page} de ${p.totalPages} (${p.totalRecords} regs)`; document.getElementById('logsPageIndicator').textContent = `${p.page}/${p.totalPages}`; const prev = document.getElementById('logsPrevPage'), next = document.getElementById('logsNextPage'); prev.disabled = p.page <= 1; next.disabled = p.page >= p.totalPages; prev.onclick = () => changeLogsPage(-1); next.onclick = () => changeLogsPage(1); }
        function changeLogsPage(dir) { const s = appState.logs; const n = s.currentPage + dir; if (n > 0 && n <= s.totalPages) { s.currentPage = n; loadLogs(); } }

        // ==========================================
        // RELATÓRIOS
        // ==========================================
        async function loadRelatorios() {
            showLoading('Gerando relatório...');
            try {
                const type = document.getElementById('reportTypeSelect').value;
                const period = document.getElementById('reportPeriodSelect').value;
                appState.relatorios.currentType = type;
                appState.relatorios.currentPeriod = period;

                const response = await getRelatorio(type, period);
                appState.relatorios.reportData = response.data;
                renderRelatorio(response.data);
            } catch (error) {
                showAlert('Erro ao carregar relatório: ' + (error.error || 'Tente novamente.'), 'error');
                document.getElementById('reportDisplayArea').innerHTML = `
                    <div class="report-empty-state" style="color: red;">
                        Erro ao carregar o relatório. Por favor, tente novamente.
                    </div>
                `;
            } finally {
                hideLoading();
            }
        }

        function filterRelatorios() {
            loadRelatorios();
        }

        async function handleExportRelatorio() {
            showLoading('Preparando exportação...');
            try {
                const type = document.getElementById('reportTypeSelect').value;
                const period = document.getElementById('reportPeriodSelect').value;
                // Por simplicidade, vamos exportar sempre CSV. Poderíamos adicionar um select para formato.
                const format = 'csv'; 

                // A chamada à API para exportação fará o download direto no navegador
                await exportarRelatorioAPI(type, period, format); 
                showAlert('Exportação iniciada. Verifique seus downloads.', 'success');
            } catch (error) {
                showAlert('Erro ao exportar relatório: ' + (error.error || 'Tente novamente.'), 'error');
            } finally {
                hideLoading();
            }
        }

        function renderRelatorio(reportData) {
            const displayArea = document.getElementById('reportDisplayArea');
            displayArea.innerHTML = ''; // Limpa a área
            
            if (!reportData) {
                displayArea.innerHTML = `<div class="report-empty-state">Nenhum dado disponível para este relatório.</div>`;
                return;
            }

            // Título do relatório
            displayArea.innerHTML += `<h3 class="report-section-title">Relatório de ${capitalize(reportData.tipo.replace(/_/g, ' '))} (${reportData.periodo === 'total' ? 'Total' : `Últimos ${reportData.periodo} dias`})</h3>`;
            displayArea.innerHTML += `<p style="margin-bottom: 20px; font-size: 14px; color: #718096;">Gerado em: ${formatDateTime(reportData.timestamp)}</p>`;

            switch (reportData.tipo) {
                case 'dashboard':
                    renderDashboardReportData(reportData);
                    break;
                case 'financeiro':
                    renderFinanceiroReportData(reportData);
                    break;
                case 'revendedores':
                    renderRevendedoresReportData(reportData);
                    break;
                case 'provedores':
                    renderProvedoresReportData(reportData);
                    break;
                case 'atividade':
                    renderAtividadeReportData(reportData);
                    break;
                case 'crescimento':
                    renderCrescimentoReportData(reportData);
                    break;
                case 'completo':
                    renderCompletoReportData(reportData);
                    break;
                default:
                    displayArea.innerHTML += `<div class="report-empty-state">Tipo de relatório desconhecido.</div>`;
                    break;
            }
        }

        function renderDashboardReportData(data) {
            const displayArea = document.getElementById('reportDisplayArea');
            displayArea.innerHTML += `
                <h4 class="report-section-title">Métricas Gerais</h4>
                <div class="report-summary-cards">
                    <div class="report-summary-card">
                        <div class="report-summary-value">${data.metricas_gerais.total_revendedores || 0}</div>
                        <div class="report-summary-label">Total Revendedores</div>
                    </div>
                    <div class="report-summary-card">
                        <div class="report-summary-value">${data.metricas_gerais.total_ativos_online || 0}</div>
                        <div class="report-summary-label">Ativos Online</div>
                    </div>
                    <div class="report-summary-card">
                        <div class="report-summary-value">${data.metricas_gerais.total_provedores || 0}</div>
                        <div class="report-summary-label">Total Provedores</div>
                    </div>
                    <div class="report-summary-card">
                        <div class="report-summary-value">${data.metricas_gerais.dias_atividade_periodo || 0}</div>
                        <div class="report-summary-label">Dias de Atividade</div>
                    </div>
                </div>

                <h4 class="report-section-title">Top Revendedores (Receita Estimada)</h4>
                <div class="table-container report-table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Revendedor</th>
                                <th>Ativos</th>
                                <th>Receita Estimada</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.ranking_ativos && data.ranking_ativos.length > 0 ? 
                                data.ranking_ativos.map((rev, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${rev.nome} (${rev.usuario})</td>
                                        <td>${rev.total_ativos}</td>
                                        <td>${formatCurrency(rev.receita_estimada_periodo)}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="4" class="report-empty-state">Nenhum top revendedor encontrado.</td></tr>`}
                        </tbody>
                    </table>
                </div>

                <h4 class="report-section-title">Crescimento no Período</h4>
                <div class="info-panel">
                    <div class="info-item">
                        <div class="info-label">Revendedores</div>
                        <div class="info-value">Atual: ${data.crescimento.revendedores.atual} | Anterior: ${data.crescimento.revendedores.anterior} | Crescimento: ${formatPercentage(data.crescimento.revendedores.percentual)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Ativos</div>
                        <div class="info-value">Atual: ${data.crescimento.ativos.atual} | Anterior: ${data.crescimento.ativos.anterior} | Crescimento: ${formatPercentage(data.crescimento.ativos.percentual)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Receita Estimada</div>
                        <div class="info-value">Atual: ${formatCurrency(data.crescimento.receita.atual)} | Anterior: ${formatCurrency(data.crescimento.receita.anterior)} | Crescimento: ${formatPercentage(data.crescimento.receita.percentual)}</div>
                    </div>
                </div>
            `;
        }

        function renderFinanceiroReportData(data) {
            const displayArea = document.getElementById('reportDisplayArea');
            displayArea.innerHTML += `
                <h4 class="report-section-title">Resumo Financeiro</h4>
                <div class="report-summary-cards">
                    <div class="report-summary-card">
                        <div class="report-summary-value">${formatCurrency(data.receita_total.total_periodo || 0)}</div>
                        <div class="report-summary-label">Receita Total Estimada</div>
                    </div>
                    <div class="report-summary-card">
                        <div class="report-summary-value">${formatCurrency(data.receita_total.receita_por_ativo_periodo || 0)}</div>
                        <div class="report-summary-label">Por Ativo</div>
                    </div>
                    <div class="report-summary-card">
                        <div class="report-summary-value">${formatCurrency(data.receita_total.receita_mensal_periodo || 0)}</div>
                        <div class="report-summary-label">Mensalistas</div>
                    </div>
                </div>

                <h4 class="report-section-title">Histórico Mensal de Receita (Estimado)</h4>
                <div class="table-container report-table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Mês/Ano</th>
                                <th>Receita Estimada</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.historico_mensal && data.historico_mensal.length > 0 ? 
                                data.historico_mensal.map(item => `
                                    <tr>
                                        <td>${item.mes_ano}</td>
                                        <td>${formatCurrency(item.receita_estimada)}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="2" class="report-empty-state">Nenhum histórico mensal encontrado.</td></tr>`}
                        </tbody>
                    </table>
                </div>

                <h4 class="report-section-title">Previsões e Inadimplência (Estimado)</h4>
                <div class="info-panel">
                    <div class="info-item">
                        <div class="info-label">Previsão 3 Meses</div>
                        <div class="info-value">${formatCurrency(data.previsoes['3_meses'] || 0)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Previsão 6 Meses</div>
                        <div class="info-value">${formatCurrency(data.previsoes['6_meses'] || 0)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Inadimplência Estimada</div>
                        <div class="info-value">${formatCurrency(data.inadimplencia.valor_estimado_em_atraso || 0)} (${formatPercentage(data.inadimplencia.percentual_inadimplencia_estimado || 0)})</div>
                    </div>
                </div>
            `;
        }

        function renderRevendedoresReportData(data) {
            const displayArea = document.getElementById('reportDisplayArea');
            displayArea.innerHTML += `
                <h4 class="report-section-title">Ranking Revendedores por Ativos</h4>
                <div class="table-container report-table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Revendedor</th>
                                <th>Total Ativos (Período)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.ranking_ativos && data.ranking_ativos.length > 0 ? 
                                data.ranking_ativos.map((rev, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${rev.nome} (${rev.usuario})</td>
                                        <td>${rev.total_ativos_periodo}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="3" class="report-empty-state">Nenhum revendedor no ranking de ativos.</td></tr>`}
                        </tbody>
                    </table>
                </div>

                <h4 class="report-section-title">Ranking Revendedores por Receita Estimada</h4>
                <div class="table-container report-table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Revendedor</th>
                                <th>Receita Estimada (Período)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.ranking_receita && data.ranking_receita.length > 0 ? 
                                data.ranking_receita.map((rev, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${rev.nome} (${rev.usuario})</td>
                                        <td>${formatCurrency(rev.receita_estimada_periodo)}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="3" class="report-empty-state">Nenhum revendedor no ranking de receita.</td></tr>`}
                        </tbody>
                    </table>
                </div>

                <h4 class="report-section-title">Novos Revendedores no Período</h4>
                <div class="table-container report-table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Revendedor</th>
                                <th>Criado Em</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.novos_revendedores && data.novos_revendedores.length > 0 ? 
                                data.novos_revendedores.map(rev => `
                                    <tr>
                                        <td>${rev.nome} (${rev.usuario})</td>
                                        <td>${formatDateTime(rev.criado_em)}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="2" class="report-empty-state">Nenhum novo revendedor no período.</td></tr>`}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderProvedoresReportData(data) {
            const displayArea = document.getElementById('reportDisplayArea');
            displayArea.innerHTML += `
                <h4 class="report-section-title">Provedores Mais Utilizados</h4>
                <div class="table-container report-table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Provedor</th>
                                <th>Total Ativos Conectados</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.mais_utilizados && data.mais_utilizados.length > 0 ? 
                                data.mais_utilizados.map((prov, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${prov.nome} (${prov.dns})</td>
                                        <td>${prov.total_ativos_conectados}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="3" class="report-empty-state">Nenhum provedor mais utilizado encontrado.</td></tr>`}
                        </tbody>
                    </table>
                </div>

                <h4 class="report-section-title">Novos Provedores no Período</h4>
                <div class="table-container report-table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Provedor</th>
                                <th>Criado Em</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.novos_provedores && data.novos_provedores.length > 0 ? 
                                data.novos_provedores.map(prov => `
                                    <tr>
                                        <td>${prov.nome} (${prov.dns})</td>
                                        <td>${formatDateTime(prov.criado_em)}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="2" class="report-empty-state">Nenhum novo provedor no período.</td></tr>`}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderAtividadeReportData(data) {
            const displayArea = document.getElementById('reportDisplayArea');
            displayArea.innerHTML += `
                <h4 class="report-section-title">Atividade Diária de Ativos</h4>
                <div class="table-container report-table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Total Ativos Online</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.atividade_diaria && data.atividade_diaria.length > 0 ? 
                                data.atividade_diaria.map(item => `
                                    <tr>
                                        <td>${formatDate(item.data)}</td>
                                        <td>${item.total_ativos_dia}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="2" class="report-empty-state">Nenhuma atividade diária encontrada.</td></tr>`}
                        </tbody>
                    </table>
                </div>

                <h4 class="report-section-title">Clients Mais Ativos (por Ações)</h4>
                <div class="table-container report-table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Client ID</th>
                                <th>Usuário</th>
                                <th>Total Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.clients_mais_ativos && data.clients_mais_ativos.length > 0 ? 
                                data.clients_mais_ativos.map(client => `
                                    <tr>
                                        <td><code>${client.client_id}</code></td>
                                        <td>${client.usuario || 'N/A'}</td>
                                        <td>${client.total_atividades_periodo}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="3" class="report-empty-state">Nenhum cliente mais ativo encontrado.</td></tr>`}
                        </tbody>
                    </table>
                </div>

                <h4 class="report-section-title">Taxa de Retenção (Estimada)</h4>
                <div class="info-panel">
                    <div class="info-item">
                        <div class="info-label">Taxa de Retenção</div>
                        <div class="info-value">${formatPercentage(data.taxa_retencao.taxa || 0)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Período Avaliado</div>
                        <div class="info-value">${data.taxa_retencao.periodo || 'N/A'}</div>
                    </div>
                </div>
            `;
        }

        function renderCrescimentoReportData(data) {
            const displayArea = document.getElementById('reportDisplayArea');
            displayArea.innerHTML += `
                <h4 class="report-section-title">Crescimento de Revendedores por Mês</h4>
                <div class="table-container report-table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Mês/Ano</th>
                                <th>Novos Revendedores</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.crescimento_revendedores && data.crescimento_revendedores.length > 0 ? 
                                data.crescimento_revendedores.map(item => `
                                    <tr>
                                        <td>${item.mes_ano}</td>
                                        <td>${item.novos_revendedores}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="2" class="report-empty-state">Nenhum dado de crescimento de revendedores.</td></tr>`}
                        </tbody>
                    </table>
                </div>

                <h4 class="report-section-title">Crescimento de Ativos por Mês</h4>
                <div class="table-container report-table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Mês/Ano</th>
                                <th>Novos Ativos</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.crescimento_ativos && data.crescimento_ativos.length > 0 ? 
                                data.crescimento_ativos.map(item => `
                                    <tr>
                                        <td>${item.mes_ano}</td>
                                        <td>${item.novos_ativos}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="2" class="report-empty-state">Nenhum dado de crescimento de ativos.</td></tr>`}
                        </tbody>
                    </table>
                </div>

                <h4 class="report-section-title">Projeções Futuras (Estimado)</h4>
                <div class="info-panel">
                    <div class="info-item">
                        <div class="info-label">Revendedores (3 Meses)</div>
                        <div class="info-value">${data.projecoes.revendedores_projecao_3m || 0}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Ativos (3 Meses)</div>
                        <div class="info-value">${data.projecoes.ativos_projecao_3m || 0}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Receita (3 Meses)</div>
                        <div class="info-value">${formatCurrency(data.projecoes.receita_projecao_3m || 0)}</div>
                    </div>
                </div>
            `;
        }

        function renderCompletoReportData(data) {
            const displayArea = document.getElementById('reportDisplayArea');
            displayArea.innerHTML += `
                <h4 class="report-section-title">Resumo Executivo</h4>
                <div class="report-summary-cards">
                    <div class="report-summary-card">
                        <div class="report-summary-value">${data.resumo_executivo.total_revendedores || 0}</div>
                        <div class="report-summary-label">Total Revendedores</div>
                    </div>
                    <div class="report-summary-card">
                        <div class="report-summary-value">${data.resumo_executivo.total_provedores || 0}</div>
                        <div class="report-summary-label">Total Provedores</div>
                    </div>
                    <div class="report-summary-card">
                        <div class="report-summary-value">${formatCurrency(data.resumo_executivo.receita_estimada_periodo || 0)}</div>
                        <div class="report-summary-label">Receita Estimada (Período)</div>
                    </div>
                    <div class="report-summary-card">
                        <div class="report-summary-value">${formatPercentage(data.resumo_executivo.crescimento_percentual_ativos || 0)}</div>
                        <div class="report-summary-label">Crescimento Ativos (Período)</div>
                    </div>
                </div>

                <h4 class="report-section-title">Métricas Principais</h4>
                <div class="info-panel">
                    <div class="info-item">
                        <div class="info-label">Revendedores Ativos</div>
                        <div class="info-value">${data.metricas_principais.total_revendedores || 0}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Ativos Online</div>
                        <div class="info-value">${data.metricas_principais.total_ativos_online || 0}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Provedores Ativos</div>
                        <div class="info-value">${data.metricas_principais.total_provedores || 0}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Dias de Atividade (Período)</div>
                        <div class="info-value">${data.metricas_principais.dias_atividade_periodo || 0}</div>
                    </div>
                </div>

                <h4 class="report-section-title">Indicadores Financeiros</h4>
                <div class="info-panel">
                    <div class="info-item">
                        <div class="info-label">Receita por Ativo (Período)</div>
                        <div class="info-value">${formatCurrency(data.indicadores_financeiros.receita_por_ativo_periodo || 0)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Receita Mensal (Período)</div>
                        <div class="info-value">${formatCurrency(data.indicadores_financeiros.receita_mensal_periodo || 0)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Total Receita (Período)</div>
                        <div class="info-value">${formatCurrency(data.indicadores_financeiros.total_periodo || 0)}</div>
                    </div>
                </div>

                <h4 class="report-section-title">Atividade do Sistema (Últimos 7 Dias)</h4>
                <div class="table-container report-table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Total Ações</th>
                                <th>Usuários Únicos</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.atividade_sistema && data.atividade_sistema.length > 0 ? 
                                data.atividade_sistema.map(item => `
                                    <tr>
                                        <td>${formatDate(item.data)}</td>
                                        <td>${item.total_acoes}</td>
                                        <td>${item.usuarios_unicos}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="3" class="report-empty-state">Nenhuma atividade recente encontrada.</td></tr>`}
                        </tbody>
                    </table>
                </div>
            `;
        }


        // ==========================================
        // FINANCEIRO
        // ==========================================
        let currentFinanceiroRevendedor = null; // Para modais de pagamento/vencimento

        async function loadFinanceiro() {
            showLoading('Carregando dados financeiros...');
            try {
                const response = await getFinanceiro();
                const financeData = response.data;

                // Atualiza cards de estatísticas
                document.getElementById('financeiroReceitaMensalPrevista').textContent = formatCurrency(financeData.stats.receita_mensal_prevista || 0);
                document.getElementById('financeiroTotalRevendedoresAtivos').textContent = financeData.stats.total_revendedores_ativos || 0;
                document.getElementById('financeiroRevendedoresVencidos').textContent = financeData.stats.revendedores_vencidos || 0;
                document.getElementById('financeiroRevendedoresProximoVencimento').textContent = financeData.stats.revendedores_proximo_vencimento || 0;

                // Renderiza histórico de cobranças
                renderFinanceiroTable(financeData.historico);

                // Renderiza projeções e análises
                renderFinanceiroAnalisesProjecoes(financeData.analises, financeData.projecoes);

            } catch (error) {
                showAlert('Erro ao carregar dados financeiros: ' + (error.error || 'Verifique a conexão com a API.'), 'error');
                document.getElementById('financeiroEmptyState').style.display = 'block';
                document.getElementById('financeiroTableBody').innerHTML = ''; // Limpa a tabela
                document.getElementById('financeiroAnalisesProjecoes').innerHTML = ''; // Limpa análises
            } finally {
                hideLoading();
            }
        }

        function renderFinanceiroTable(historico) {
            const tbody = document.getElementById('financeiroTableBody');
            const emptyState = document.getElementById('financeiroEmptyState');
            
            if (!historico || historico.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';

            tbody.innerHTML = historico.map(item => {
                let statusClass = '';
                let statusText = '';
                switch (item.status_pagamento_consolidado) { // Usando o status consolidado
                    case 'em_dia':
                        statusClass = 'status-ativo';
                        statusText = 'Em Dia';
                        break;
                    case 'proximo_vencimento':
                        statusClass = 'status-inativo'; // Amarelo/Alerta
                        statusText = `Vence em ${item.dias_para_vencimento_consolidado} dias`;
                        break;
                    case 'vencido':
                        statusClass = 'status-bloqueado'; // Vermelho
                        statusText = `Vencido (${Math.abs(item.dias_para_vencimento_consolidado)} dias)`;
                        break;
                    case 'pendente':
                        statusClass = 'status-pendente'; // Laranja
                        statusText = 'Fatura Pendente';
                        break;
                    case 'parcialmente_paga':
                        statusClass = 'status-parcialmente_paga'; // Amarelo claro
                        statusText = 'Parcialmente Paga';
                        break;
                    case 'paga':
                        statusClass = 'status-paga'; // Verde
                        statusText = 'Paga';
                        break;
                    case 'cancelada':
                        statusClass = 'status-cancelada'; // Cinza
                        statusText = 'Cancelada';
                        break;
                    case 'indefinido':
                        statusClass = '';
                        statusText = 'Indefinido';
                        break;
                    case 'erro':
                        statusClass = 'status-bloqueado';
                        statusText = 'Erro';
                        break;
                    default:
                        statusClass = '';
                        statusText = item.status_pagamento_consolidado;
                }

                const vencimentoDisplay = item.fatura_pendente_data_vencimento ? formatDate(item.fatura_pendente_data_vencimento) : 'N/A'; // Data de vencimento da fatura
                const ultimaAtividadeDisplay = item.ultima_atividade ? formatDateTime(item.ultima_atividade) : 'N/A';

                return `
                <tr>
                    <td><strong>${item.revendedor_nome}</strong><br><small>${item.revendedor_usuario}</small></td>
                    <td>${item.tipo_cobranca_configurada === 'por_ativo' ? 'Por Ativo' : 'Mensal'}</td>
                    <td>${item.ativos_online_count} / ${item.ativos_total_count}</td>
                    <td>${formatCurrency(item.valor_calculado_atual)}</td>
                    <td>${vencimentoDisplay}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${ultimaAtividadeDisplay} (${item.dias_desde_ultima_atividade} dias)</td>
                    <td style="display: flex; gap: 5px;">
                        <button class="btn btn-success btn-sm" onclick='openMarcarPagamentoModal(${JSON.stringify(item)})'>Pagar</button>
                        <button class="btn btn-secondary btn-sm" onclick='openAtualizarVencimentoModal(${JSON.stringify(item)})'>Vencimento</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderFinanceiroAnalisesProjecoes(analises, projecoes) {
            const displayArea = document.getElementById('financeiroAnalisesProjecoes');
            displayArea.innerHTML = `
                <div class="info-item">
                    <div class="info-label">Taxa de Ativação Revendedores</div>
                    <div class="info-value">${formatPercentage(analises.taxa_ativacao_revendedores || 0)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Taxa de Utilização Ativos</div>
                    <div class="info-value">${formatPercentage(analises.taxa_utilizacao_ativos || 0)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ticket Médio por Revendedor</div>
                    <div class="info-value">${formatCurrency(analises.ticket_medio || 0)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Top Revendedor (Receita)</div>
                    <div class="info-value">${analises.top_revendedores_receita && analises.top_revendedores_receita.length > 0 ? `${analises.top_revendedores_receita[0].nome} (${formatCurrency(analises.top_revendedores_receita[0].receita_estimada)})` : 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Projeção Próximo Mês</div>
                    <div class="info-value">${formatCurrency(projecoes.projecao_1_mes || 0)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Projeção 3 Meses</div>
                    <div class="info-value">${formatCurrency(projecoes.projecao_3_meses || 0)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Projeção 6 Meses</div>
                    <div class="info-value">${formatCurrency(projecoes.projecao_6_meses || 0)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Projeção 12 Meses</div>
                    <div class="info-value">${formatCurrency(projecoes.projecao_12_meses || 0)}</div>
                </div>
            `;
        }

        async function processarCobranca() {
            showConfirm('Processar Cobranças', 'Esta ação irá calcular e registrar as cobranças para todos os revendedores ativos que não possuem fatura pendente, gerando novas faturas. Deseja continuar?', async () => {
                showLoading('Processando cobranças...');
                try {
                    const response = await processarCobrancaAPI();
                    showAlert(response.message || 'Cobranças processadas com sucesso!', 'success');
                    loadFinanceiro(); // Recarrega os dados financeiros
                } catch (error) {
                    showAlert('Erro ao processar cobranças: ' + (error.error || 'Tente novamente.'), 'error');
                } finally {
                    hideLoading();
                }
            });
        }

        async function bloquearRevendedoresVencidos() {
            showConfirm('Bloquear Revendedores Vencidos', 'Esta ação irá BLOQUEAR automaticamente todos os painéis de revendedores com faturas vencidas e não pagas. Deseja continuar?', async () => {
                showLoading('Bloqueando revendedores...');
                try {
                    const response = await bloquearRevendedoresVencidosAPI();
                    showAlert(response.message || 'Revendedores vencidos bloqueados com sucesso!', 'success');
                    loadFinanceiro(); // Recarrega os dados financeiros
                    loadRevendedores(); // Atualiza a lista de revendedores também
                } catch (error) {
                    showAlert('Erro ao bloquear revendedores: ' + (error.error || 'Tente novamente.'), 'error');
                } finally {
                    hideLoading();
                }
            }, 'btn-danger');
        }

        function openMarcarPagamentoModal(item) {
            currentFinanceiroRevendedor = item; // Guarda o item completo
            document.getElementById('pagamentoRevendedorId').value = item.id_revendedor;
            document.getElementById('pagamentoFaturaId').value = item.fatura_pendente_id || ''; // Pode ser nulo
            document.getElementById('pagamentoRevendedorNome').value = `${item.revendedor_nome} (${item.revendedor_usuario})`;
            document.getElementById('pagamentoValor').value = item.fatura_pendente_valor || item.valor_calculado_atual || ''; // Sugere o valor da fatura ou o calculado
            document.getElementById('pagamentoObservacoes').value = '';
            document.getElementById('pagamentoMetodo').value = 'manual'; // Default
            document.getElementById('marcarPagamentoModal').classList.add('show');
        }

        async function salvarPagamento() {
            const idRevendedor = document.getElementById('pagamentoRevendedorId').value;
            const idFatura = document.getElementById('pagamentoFaturaId').value || null; // Pega o ID da fatura
            const valorPago = parseFloat(document.getElementById('pagamentoValor').value);
            const metodoPagamento = document.getElementById('pagamentoMetodo').value;
            const observacoes = document.getElementById('pagamentoObservacoes').value;

            if (isNaN(valorPago) || valorPago <= 0) {
                showAlert('Por favor, insira um valor de pagamento válido.', 'error');
                return;
            }

            showLoading('Registrando pagamento...');
            try {
                await marcarComoPago(idRevendedor, valorPago, observacoes, idFatura, metodoPagamento);
                showAlert('Pagamento registrado com sucesso!', 'success');
                closeModal('marcarPagamentoModal');
                loadFinanceiro(); // Recarrega os dados financeiros
            } catch (error) {
                showAlert('Erro ao registrar pagamento: ' + (error.error || 'Tente novamente.'), 'error');
            } finally {
                hideLoading();
            }
        }

        function openAtualizarVencimentoModal(item) {
            currentFinanceiroRevendedor = item; // Guarda o item completo
            document.getElementById('vencimentoRevendedorId').value = item.id_revendedor;
            document.getElementById('vencimentoRevendedorNome').value = `${item.revendedor_nome} (${item.revendedor_usuario})`;
            
            // Preenche com a data atual + 30 dias se não houver vencimento ou se já estiver vencido
            let defaultDate = new Date();
            // Se houver uma data de vencimento na fatura pendente, usa ela como base
            if (item.fatura_pendente_data_vencimento && new Date(item.fatura_pendente_data_vencimento + 'T00:00:00') > defaultDate) {
                defaultDate = new Date(item.fatura_pendente_data_vencimento + 'T00:00:00');
            } else if (item.data_vencimento && new Date(item.data_vencimento + 'T00:00:00') > defaultDate) { // Usa a data de vencimento do revendedor
                 defaultDate = new Date(item.data_vencimento + 'T00:00:00');
            }
            defaultDate.setDate(defaultDate.getDate() + 30); // Sugere 30 dias a partir da data base
            document.getElementById('novaDataVencimento').value = defaultDate.toISOString().split('T')[0];
            
            document.getElementById('atualizarVencimentoModal').classList.add('show');
        }

        async function salvarAtualizacaoVencimento() {
            const idRevendedor = document.getElementById('vencimentoRevendedorId').value;
            const novaDataVencimento = document.getElementById('novaDataVencimento').value;

            if (!novaDataVencimento) {
                showAlert('Por favor, selecione uma nova data de vencimento.', 'error');
                return;
            }

            showLoading('Atualizando vencimento...');
            try {
                await atualizarVencimentoRevendedorAPI(idRevendedor, novaDataVencimento);
                showAlert('Vencimento atualizado com sucesso!', 'success');
                closeModal('atualizarVencimentoModal');
                loadFinanceiro(); // Recarrega os dados financeiros
                loadRevendedores(); // Atualiza a lista de revendedores também
            } catch (error) {
                showAlert('Erro ao atualizar vencimento: ' + (error.error || 'Tente novamente.'), 'error');
            } finally {
                hideLoading();
            }
        }

        async function openGerarFaturaManualModal() {
            document.getElementById('gerarFaturaManualForm').reset();
            document.getElementById('gerarFaturaManualModalTitle').textContent = '➕ Gerar Fatura Manual';
            document.getElementById('faturaManualValor').value = '';
            document.getElementById('faturaManualObservacoes').value = '';
            document.getElementById('faturaManualTipoCobranca').value = 'manual';

            // Preenche a data de vencimento para 30 dias no futuro
            const hoje = new Date();
            hoje.setDate(hoje.getDate() + 30);
            document.getElementById('faturaManualDataVencimento').value = hoje.toISOString().split('T')[0];

            // Carregar revendedores para o select
            const revendedorSelect = document.getElementById('faturaManualRevendedor');
            revendedorSelect.innerHTML = '<option value="">Carregando...</option>';
            try {
                const resRevendedores = await listarRevendedores({limit: 1000});
                revendedorSelect.innerHTML = '<option value="">Selecione um Revendedor</option>' + 
                    resRevendedores.data.data.map(r => `<option value="${r.id_revendedor}">${r.nome} (${r.usuario})</option>`).join('');
            } catch (e) {
                revendedorSelect.innerHTML = '<option value="">Erro ao carregar revendedores</option>';
                showAlert('Erro ao carregar lista de revendedores para fatura manual.', 'error');
            }

            document.getElementById('gerarFaturaManualModal').classList.add('show');
        }

        async function salvarFaturaManual() {
            const idRevendedor = document.getElementById('faturaManualRevendedor').value;
            const valorTotal = parseFloat(document.getElementById('faturaManualValor').value);
            const dataVencimento = document.getElementById('faturaManualDataVencimento').value;
            const tipoCobranca = document.getElementById('faturaManualTipoCobranca').value;
            const observacoes = document.getElementById('faturaManualObservacoes').value;

            if (!idRevendedor || isNaN(valorTotal) || valorTotal <= 0 || !dataVencimento) {
                showAlert('Por favor, preencha todos os campos obrigatórios e válidos.', 'error');
                return;
            }

            showLoading('Gerando fatura manual...');
            try {
                await gerarFaturaManualAPI(idRevendedor, valorTotal, dataVencimento, observacoes, tipoCobranca);
                showAlert('Fatura manual gerada com sucesso!', 'success');
                closeModal('gerarFaturaManualModal');
                loadFinanceiro(); // Recarrega os dados financeiros
            } catch (error) {
                showAlert('Erro ao gerar fatura manual: ' + (error.error || 'Tente novamente.'), 'error');
            } finally {
                hideLoading();
            }
        }


        // ==========================================
        // SEGURANÇA & DOMÍNIO
        // ==========================================
        async function loadSeguranca() { showLoading('Carregando...'); try { const r = await getServerInfo(); const i = r.data; const p = document.getElementById('serverInfoPanel'); p.innerHTML = `<div class="info-item"><div class="info-label">IP do Servidor</div><div class="info-value">${i.server_ip||'N/A'}</div></div><div class="info-item"><div class="info-label">Versão PHP</div><div class="info-value">${i.php_version||'N/A'}</div></div><div class="info-item"><div class="info-label">Versão SQLite</div><div class="info-value">${i.sqlite_version||'N/A'}</div></div><div class="info-item"><div class="info-label">Software</div><div class="info-value">${i.server_software||'N/A'}</div></div>`; } catch (e) { showAlert('Erro ao carregar informações.', 'error'); } finally { hideLoading(); } }
        function setupPasswordStrengthChecker() {
            const n = document.getElementById('novaSenha'), c = document.getElementById('confirmarSenha');
            const check = async () => { const N = n.value, C = c.value, b = document.getElementById('btnAlterarSenha'); if (N === '') { updateStrengthBar(0, 'Vazio'); b.disabled = true; return; } try { const r = await verificarForcaSenha(N); const s = r.data; updateStrengthBar(s.score, s.nivel, s.sugestoes); b.disabled = !(s.score >= 40 && N === C); } catch (e) { updateStrengthBar(0, 'Erro'); b.disabled = true; } };
            n.addEventListener('input', check); c.addEventListener('input', check);
        }
        function updateStrengthBar(score, nivel, sugestoes = []) { const m = document.getElementById('strengthMeter'), t = document.getElementById('strengthText'); const c = {'Muito Fraca':'muito-fraca','Fraca':'fraca','Média':'media','Boa':'boa','Forte':'forte'}, o = {'Muito Fraca':'#e53e3e','Fraca':'#dd6b20','Média':'#d69e2e','Boa':'#38a169','Forte':'#2f855a'}; m.className = 'strength-meter'; if (nivel && c[nivel]) m.classList.add(c[nivel]); t.textContent = `Força: ${nivel||'N/A'}`; t.style.color = o[nivel]||'#4a5568'; if (sugestoes.length > 0 && score < 100) t.textContent += ` (${sugestoes[0]})`; }
        async function handleAlterarSenha() { const b = document.getElementById('btnAlterarSenha'), d = { senha_atual: document.getElementById('senhaAtual').value, nova_senha: document.getElementById('novaSenha').value, confirmar_senha: document.getElementById('confirmarSenha').value }; if (!d.senha_atual || !d.nova_senha) { showAlert('Preencha todos os campos.', 'error'); return; } showLoading('Alterando...'); b.disabled = true; try { await alterarSenhaAdmin(d); showAlert('Senha alterada!', 'success'); document.getElementById('senhaAtual').value = ''; document.getElementById('novaSenha').value = ''; document.getElementById('confirmarSenha').value = ''; updateStrengthBar(0, 'Vazio'); } catch (e) { showAlert('Erro: ' + (e.error || 'Tente novamente.'), 'error'); } finally { hideLoading(); } }

        // ==========================================
        // CONFIGURAÇÕES E BACKUP
        // ==========================================
        async function loadConfiguracoes() { showLoading(); try { const r = await getConfiguracoes(); const c = r.data || {}; document.getElementById('nomeSistema').value = c.nome_sistema || 'NomaTV Painel'; document.getElementById('fusoHorario').value = c.fuso_horario || 'America/Sao_Paulo'; document.getElementById('idiomaPadrao').value = c.idioma_padrao || 'pt-BR'; } catch (e) { showAlert('Erro ao carregar configurações.', 'error'); } finally { hideLoading(); } }
        async function saveConfigGerais() { showLoading('Salvando...'); try { const c = { nome_sistema: document.getElementById('nomeSistema').value, fuso_horario: document.getElementById('fusoHorario').value, idioma_padrao: document.getElementById('idiomaPadrao').value }; await salvarConfiguracoes(c); showAlert('Configurações salvas!', 'success'); } catch (e) { showAlert('Erro ao salvar: ' + (e.error || 'Verifique os valores'), 'error'); } finally { hideLoading(); } }
        async function openBackupModal() {
            showLoading(); const t = document.getElementById('backupTableBody'); t.innerHTML = `<tr><td colspan="4" style="text-align: center;">Carregando...</td></tr>`; document.getElementById('backupModal').classList.add('show');
            try {
                const r = await listarBackups(); const b = r.data || [];
                if (b.length === 0) { t.innerHTML = `<tr><td colspan="4" style="text-align: center;">Nenhum backup encontrado.</td></tr>`; } 
                else { t.innerHTML = b.map(i => `<tr><td><code>${i.filename}</code></td><td>${new Date(i.date).toLocaleString('pt-BR')}</td><td>${(i.size / 1024 / 1024).toFixed(2)} MB</td><td style="display: flex; gap: 5px;"><button class="btn btn-primary btn-sm" onclick="handleDownloadBackup('${i.filename}')">Baixar</button><button class="btn btn-danger btn-sm" onclick="handleRestoreBackup('${i.filename}')">Restaurar</button></td></tr>`).join(''); }
            } catch (e) { showAlert('Erro ao listar backups.', 'error'); t.innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">Falha ao carregar.</td></tr>`; } 
            finally { hideLoading(); }
        }
        async function handleCreateBackup() { const b = document.getElementById('btnCriarBackup'); showLoading('Criando backup...'); b.disabled = true; try { const blob = await criarBackupCompleto(); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; const t = new Date().toISOString().slice(0, 19).replace(/:/g, '-'); a.download = `backup_nomatv_${t}.zip`; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); a.remove(); showAlert('Backup criado e download iniciado!', 'success'); } catch (e) { showAlert('Erro ao criar o backup.', 'error'); } finally { hideLoading(); b.disabled = false; } }
        async function handleDownloadBackup(filename) { showLoading(`Baixando...`); try { const blob = await baixarBackup(filename); const url = window.URL.createObjectURL(blob); const a = new URLSearchParams(window.location.search); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url); } catch (e) { showAlert('Erro ao baixar o backup.', 'error'); } finally { hideLoading(); } }
        function handleRestoreBackup(filename) { showConfirm('⚠️ ATENÇÃO: AÇÃO IRREVERSÍVEL ⚠️', `Restaurar o backup "${filename}" substituirá TODOS os dados atuais. Deseja continuar?`, async () => { closeModal('backupModal'); showLoading('Restaurando sistema...'); try { const r = await restaurarBackup(filename); showAlert(r.message || 'Sistema restaurado!', 'success'); setTimeout(() => window.location.reload(), 3000); } catch (e) { showAlert('ERRO CRÍTICO: ' + (e.error || 'Sistema instável'), 'error'); hideLoading(); } }, 'btn-danger'); }

        // ==========================================
        // INICIALIZAÇÃO
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async () => {
            // ✅ VERIFICAR AUTENTICAÇÃO USANDO api.js
            checkAuthentication();
            
            // Depois carrega o dashboard
            const firstNavItem = document.querySelector('.nav-item');
            if(firstNavItem) {
                showSection('dashboard', firstNavItem);
            }
            setupPasswordStrengthChecker();
        });
    </script>


</body></html>